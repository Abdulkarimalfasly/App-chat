
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🦂 شات وتين العقرب</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ==================== CSS كامل ومعدل ==================== */
        /* إعادة تعيين الأنماط الأساسية */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            /* الألوان الأساسية - تدرج وردي أنيق */
            --primary-color: #e91e63;
            --primary-light: #f8bbd9;
            --primary-dark: #ad1457;
            --secondary-color: #9c27b0;
            --accent-color: #ff4081;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --info-color: #2196F3;
            /* ألوان الخلفية */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-tertiary: rgba(255, 255, 255, 0.1);
            --bg-card: rgba(255, 255, 255, 0.9);
            --bg-modal: rgba(0, 0, 0, 0.8);
            --bg-sidebar: rgba(255, 255, 255, 0.98);
            /* ألوان النص */
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --text-muted: #bdc3c7;
            --text-white: #ffffff;
            /* الحدود والظلال */
            --border-color: rgba(0, 0, 0, 0.1);
            --border-light: rgba(255, 255, 255, 0.2);
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 8px 30px rgba(0, 0, 0, 0.25);
            --shadow-glow: 0 0 20px rgba(233, 30, 99, 0.3);
            /* المسافات */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-xxl: 3rem;
            /* الخطوط */
            --font-family: 'Segoe UI', 'Cairo', Tahoma, Geneva, Verdana, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-md: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-xxl: 1.5rem;
            /* الانتقالات */
            --transition-fast: 0.2s ease;
            --transition-medium: 0.3s ease;
            --transition-slow: 0.5s ease;
            /* نصف القطر */
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 18px;
            --radius-xl: 24px;
            --radius-full: 50%;
        }
        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            direction: rtl;
            line-height: 1.6;
        }
        /* الشاشات */
        .screen {
            display: none;
            min-height: 100vh;
        }
        .screen.active {
            display: block;
        }
        /* شاشة تسجيل الدخول */
        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
        }
        #loginScreen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://images.pexels.com/photos/1323550/pexels-photo-1323550.jpeg?auto=compress&cs=tinysrgb&w=1920&h=1080&fit=crop') center/cover;
            opacity: 0.1;
            z-index: 0;
        }
        .login-container {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xxl);
            width: 100%;
            max-width: 420px;
            box-shadow: var(--shadow-heavy);
            position: relative;
            z-index: 1;
            animation: slideInUp 0.6s ease;
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .login-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }
        .logo h1 {
            font-size: var(--font-size-xxl);
            margin-bottom: var(--spacing-sm);
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        .logo p {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }
        .login-tabs {
            display: flex;
            margin-bottom: var(--spacing-lg);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: var(--spacing-xs);
            gap: var(--spacing-xs);
        }
        .tab-btn {
            flex: 1;
            padding: var(--spacing-md);
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: var(--font-size-sm);
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }
        .tab-btn.active {
            background: var(--primary-color);
            color: var(--text-white);
            box-shadow: var(--shadow-light);
            transform: translateY(-1px);
        }
        .auth-form {
            display: none;
        }
        .auth-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .input-group {
            position: relative;
            margin-bottom: var(--spacing-lg);
        }
        .input-group i {
            position: absolute;
            right: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            z-index: 1;
        }
        .input-group input,
        .input-group select {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-xl);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: var(--font-size-md);
            transition: var(--transition-fast);
            font-family: var(--font-family);
        }
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
            transform: translateY(-1px);
        }
        .auth-btn {
            width: 100%;
            padding: var(--spacing-lg);
            border: none;
            border-radius: var(--radius-md);
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: var(--text-white);
            font-size: var(--font-size-md);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
            box-shadow: var(--shadow-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
        }
        .auth-btn:active {
            transform: translateY(0);
        }
        /* شاشة الحظر */
        #banScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--error-color) 0%, #d32f2f 100%);
        }
        .ban-container {
            text-align: center;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xxl);
            max-width: 500px;
            box-shadow: var(--shadow-heavy);
            animation: slideInUp 0.6s ease;
        }
        .ban-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-lg);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .ban-reason {
            font-size: var(--font-size-lg);
            margin: var(--spacing-lg) 0;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            border-right: 4px solid var(--error-color);
        }
        .contact-info {
            margin: var(--spacing-lg) 0;
            padding: var(--spacing-lg);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }
        .contact-info a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition-fast);
        }
        .contact-info a:hover {
            text-decoration: underline;
        }
        /* الشاشة الرئيسية */
        #mainScreen {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-secondary);
        }
        /* الشريط العلوي */
        .main-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        .hamburger-btn {
            padding: var(--spacing-sm);
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .hamburger-btn:hover {
            background: var(--primary-color);
            color: var(--text-white);
            transform: translateY(-1px);
        }
        .app-logo h1 {
            font-size: var(--font-size-xl);
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            font-weight: 700;
        }
        .header-center {
            flex: 1;
            display: flex;
            justify-content: center;
            max-width: 300px;
            margin: 0 var(--spacing-lg);
        }
        .room-selector select {
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: var(--transition-fast);
            min-width: 200px;
        }
        .room-selector select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        .header-btn {
            position: relative;
            padding: var(--spacing-sm);
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-btn:hover {
            background: var(--primary-color);
            color: var(--text-white);
            transform: translateY(-1px);
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            left: -5px;
            background: var(--error-color);
            color: white;
            border-radius: var(--radius-full);
            padding: 2px 6px;
            font-size: var(--font-size-xs);
            min-width: 18px;
            text-align: center;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }
        .user-profile-mini {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            transition: var(--transition-fast);
            margin-right: var(--spacing-md);
            background: var(--bg-tertiary);
        }
        .user-profile-mini:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
        }
        .user-avatar-mini {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            margin-left: var(--spacing-md);
            border: 2px solid var(--primary-color);
            object-fit: cover;
        }
        .user-info-mini {
            display: flex;
            flex-direction: column;
        }
        .user-name {
            font-weight: 600;
            font-size: var(--font-size-md);
            color: var(--text-primary);
        }
        .user-rank {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
        }
        /* المحتوى الرئيسي */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        /* منطقة الدردشة */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-secondary);
        }
        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-lg);
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
        }
        .chat-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: var(--font-size-xl);
        }
        .chat-controls {
            display: flex;
            gap: var(--spacing-sm);
        }
        .control-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--font-size-sm);
        }
        .control-btn:hover {
            background: var(--primary-color);
            color: var(--text-white);
            transform: translateY(-1px);
        }
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
            background: var(--bg-secondary);
            scroll-behavior: smooth;
        }
        .welcome-message {
            text-align: center;
            padding: var(--spacing-xxl);
            margin: var(--spacing-xl) 0;
        }
        .welcome-content {
            background: var(--bg-card);
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .welcome-content h3 {
            color: var(--primary-color);
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-xl);
        }
        .welcome-content p {
            color: var(--text-secondary);
        }
        .message {
            display: flex;
            margin-bottom: var(--spacing-lg);
            animation: messageSlideIn 0.4s ease;
            align-items: flex-start;
        }
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .message.own {
            flex-direction: row-reverse;
        }
        .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: var(--radius-full);
            margin: 0 var(--spacing-md);
            border: 2px solid var(--primary-color);
            cursor: pointer;
            object-fit: cover;
            transition: var(--transition-fast);
        }
        .message-avatar:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-glow);
        }
        .message-content {
            max-width: 70%;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            transition: var(--transition-fast);
        }
        .message-content:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        .message.own .message-content {
            background: linear-gradient(45deg, var(--primary-color), var(--primary-light));
            color: var(--text-white);
        }
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }
        .message-author {
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .message-author:hover {
            color: var(--primary-color);
        }
        .message-rank {
            font-size: var(--font-size-xs);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            background: var(--accent-color);
            color: white;
            font-weight: 500;
        }
        .message-time {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            margin-right: auto;
        }
        .message-text {
            line-height: 1.6;
            word-wrap: break-word;
            font-size: var(--font-size-md);
        }
        .message-media {
            margin-top: var(--spacing-sm);
        }
        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        .message-image:hover {
            transform: scale(1.02);
        }
        .message-audio {
            width: 100%;
            margin-top: var(--spacing-sm);
            border-radius: var(--radius-md);
        }
        .quoted-message {
            background: var(--bg-tertiary);
            border-right: 3px solid var(--primary-color);
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quoted-content {
            flex: 1;
        }
        .quoted-author {
            font-weight: 600;
            color: var(--primary-color);
            font-size: var(--font-size-sm);
        }
        .quoted-text {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin-right: var(--spacing-sm);
        }
        .cancel-quote {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
        }
        .cancel-quote:hover {
            background: var(--error-color);
            color: white;
        }
        .message-input-container {
            padding: var(--spacing-lg);
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }
        .input-tools {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
        }
        .tool-btn {
            padding: var(--spacing-sm);
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tool-btn:hover {
            background: var(--primary-color);
            color: var(--text-white);
            transform: translateY(-1px);
        }
        .tool-btn.recording {
            background: var(--error-color);
            color: white;
            animation: pulse 1s infinite;
        }
        .message-input-wrapper {
            display: flex;
            gap: var(--spacing-sm);
            align-items: flex-end;
        }
        #messageInput {
            flex: 1;
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: var(--font-size-md);
            resize: none;
            min-height: 50px;
            max-height: 120px;
            font-family: var(--font-family);
            transition: var(--transition-fast);
        }
        #messageInput:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
        }
        .send-btn {
            padding: var(--spacing-md);
            border: none;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: var(--text-white);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            min-width: 60px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-light);
        }
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        /* الشريط الجانبي للمستخدمين */
        .users-sidebar {
            width: 320px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
        }
        .sidebar-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: var(--font-size-lg);
            font-weight: 600;
        }
        .online-count {
            background: var(--success-color);
            color: white;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        .users-list {
            flex: 1;
            padding: var(--spacing-md);
        }
        .user-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            border: 1px solid transparent;
            margin-bottom: var(--spacing-sm);
            background: var(--bg-card);
        }
        .user-item:hover {
            background: var(--primary-light);
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: var(--radius-full);
            margin-left: var(--spacing-md);
            border: 2px solid var(--success-color);
            object-fit: cover;
        }
        .user-details {
            flex: 1;
        }
        .user-display-name {
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-primary);
        }
        .user-status {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
        }
        /* شريط التحكم السفلي */
        .bottom-control-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        .music-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        .volume-control i {
            color: var(--text-secondary);
        }
        #volumeSlider {
            width: 100px;
            height: 4px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            outline: none;
            cursor: pointer;
        }
        #volumeSlider::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: var(--radius-full);
            background: var(--primary-color);
            cursor: pointer;
        }
        .now-playing {
            flex: 1;
            text-align: center;
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            padding: var(--spacing-sm);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }
        .song-title {
            font-weight: 500;
        }
        /* المودالات */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-modal);
            z-index: 1000;
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 1;
            backdrop-filter: blur(10px);
        }
        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: var(--font-size-xl);
            font-weight: 600;
        }
        .close-btn {
            padding: var(--spacing-sm);
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-btn:hover {
            background: var(--error-color);
            color: white;
            transform: rotate(90deg);
        }
        /* القائمة الرئيسية */
        .main-menu {
            width: 700px;
        }
        .menu-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            padding: var(--spacing-xl);
        }
        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spacing-xl);
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition-fast);
            border: 1px solid var(--border-color);
            text-align: center;
            box-shadow: var(--shadow-light);
        }
        .menu-item:hover {
            background: var(--primary-light);
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-color);
        }
        .menu-item i {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-md);
            color: var(--primary-color);
        }
        .menu-item span {
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-lg);
            color: var(--text-primary);
        }
        .menu-item p {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            line-height: 1.5;
        }
        /* مودال الملف الشخصي */
        .profile-modal {
            width: 900px;
        }
        .profile-content {
            padding: 0;
        }
        .profile-cover {
            position: relative;
            height: 250px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            overflow: hidden;
        }
        .profile-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .change-cover-btn {
            position: absolute;
            bottom: var(--spacing-md);
            left: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--font-size-sm);
        }
        .change-cover-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }
        .profile-info {
            padding: var(--spacing-xl);
        }
        .profile-avatar-section {
            margin-bottom: var(--spacing-xl);
        }
        .profile-avatars {
            display: flex;
            gap: var(--spacing-xl);
            justify-content: center;
            margin-top: -60px;
            margin-bottom: var(--spacing-xl);
        }
        .avatar-slot {
            position: relative;
            text-align: center;
        }
        .avatar-slot img {
            width: 120px;
            height: 120px;
            border-radius: var(--radius-full);
            border: 4px solid var(--bg-card);
            object-fit: cover;
            box-shadow: var(--shadow-medium);
            transition: var(--transition-fast);
        }
        .avatar-slot img:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-glow);
        }
        .avatar-slot button {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 36px;
            height: 36px;
            border: none;
            background: var(--primary-color);
            color: var(--text-white);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-light);
        }
        .avatar-slot button:hover {
            background: var(--secondary-color);
            transform: scale(1.1);
        }
        .profile-stats {
            display: flex;
            justify-content: center;
            gap: var(--spacing-xxl);
            margin: var(--spacing-xl) 0;
        }
        .stat-item {
            text-align: center;
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            min-width: 100px;
        }
        .stat-number {
            display: block;
            font-size: var(--font-size-xxl);
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-xs);
        }
        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            font-weight: 500;
        }
        .profile-actions {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }
        .profile-details {
            margin-top: var(--spacing-xl);
        }
        .profile-tabs {
            display: flex;
            margin-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            gap: var(--spacing-sm);
        }
        .profile-tabs .tab-btn {
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
            border-bottom: 3px solid transparent;
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 500;
        }
        .profile-tabs .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: var(--bg-tertiary);
        }
        .profile-tab {
            display: none;
            padding: var(--spacing-lg);
        }
        .profile-tab.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        .info-section,
        .settings-section,
        .music-section,
        .decorations-section {
            margin-bottom: var(--spacing-xl);
        }
        .info-section label,
        .settings-section label,
        .music-section label,
        .decorations-section label {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
            font-weight: 600;
            font-size: var(--font-size-md);
        }
        .info-section input,
        .info-section select,
        .info-section textarea,
        .settings-section input,
        .settings-section select,
        .music-section input,
        .decorations-section input,
        .decorations-section select {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: var(--font-size-md);
            transition: var(--transition-fast);
            font-family: var(--font-family);
        }
        .info-section input:focus,
        .info-section select:focus,
        .info-section textarea:focus,
        .settings-section input:focus,
        .settings-section select:focus,
        .music-section input:focus,
        .decorations-section input:focus,
        .decorations-section select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
        }
        .info-section textarea {
            resize: vertical;
            min-height: 100px;
            line-height: 1.6;
        }
        .feature-note {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            margin-top: var(--spacing-sm);
            font-style: italic;
            padding: var(--spacing-sm);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            border-right: 3px solid var(--warning-color);
        }
        /* الأخبار */
        .news-modal {
            width: 800px;
        }
        .news-post-form {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }
        .news-post-form textarea {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            resize: vertical;
            min-height: 120px;
            margin-bottom: var(--spacing-md);
            font-family: var(--font-family);
            line-height: 1.6;
        }
        .news-post-form textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
        }
        .news-form-actions {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
            flex-wrap: wrap;
        }
        .news-feed {
            max-height: 500px;
            overflow-y: auto;
            padding: var(--spacing-lg);
        }
        .news-item {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            transition: var(--transition-fast);
        }
        .news-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        .news-header-info {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        .news-author-avatar {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-full);
            margin-left: var(--spacing-md);
            border: 2px solid var(--primary-color);
            object-fit: cover;
        }
        .news-author-info h4 {
            margin: 0 0 4px 0;
            color: var(--text-primary);
            font-weight: 600;
        }
        .news-time {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
        }
        .news-content {
            margin-bottom: var(--spacing-md);
            line-height: 1.6;
            color: var(--text-primary);
        }
        .news-media img,
        .news-media video {
            width: 100%;
            max-height: 400px;
            border-radius: var(--radius-md);
            margin-top: var(--spacing-md);
            object-fit: cover;
        }
        /* القصص */
        .stories-modal {
            width: 700px;
        }
        .add-story-section {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            background: var(--bg-tertiary);
        }
        .add-story-btn {
            padding: var(--spacing-md) var(--spacing-xl);
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: var(--text-white);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-light);
        }
        .add-story-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        .stories-container {
            display: flex;
            gap: var(--spacing-md);
            padding: var(--spacing-xl);
            overflow-x: auto;
            min-height: 300px;
        }
        .story-item {
            position: relative;
            width: 150px;
            height: 250px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition-fast);
            border: 3px solid transparent;
            flex-shrink: 0;
            box-shadow: var(--shadow-light);
        }
        .story-item:hover {
            transform: scale(1.05);
            border-color: var(--primary-color);
            box-shadow: var(--shadow-glow);
        }
        .story-item img,
        .story-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* غرفة المسابقات */
        .quiz-room-modal {
            width: 800px;
        }
        .quiz-stats {
            display: flex;
            justify-content: space-around;
            padding: var(--spacing-xl);
            background: var(--bg-tertiary);
            margin-bottom: var(--spacing-lg);
        }
        .quiz-question {
            padding: var(--spacing-xl);
            text-align: center;
        }
        .quiz-question h3 {
            margin-bottom: var(--spacing-xl);
            font-size: var(--font-size-xxl);
            color: var(--text-primary);
        }
        .question-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }
        .option-btn {
            padding: var(--spacing-lg);
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: var(--font-size-md);
            font-weight: 500;
        }
        .option-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        .quiz-timer {
            font-size: var(--font-size-xl);
            color: var(--warning-color);
            font-weight: 700;
            background: var(--bg-tertiary);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            display: inline-block;
        }
        /* ==================== إضافة تلميح المسابقة ==================== */
        .hint-section {
            background: #fff8e1;
            border: 1px solid #ffc107;
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
            animation: fadeIn 0.5s ease;
        }
        .hint-section i {
            color: #ff9800;
            margin-left: var(--spacing-sm);
        }
        /* ==================== نهاية إضافة تلميح المسابقة ==================== */
        .quiz-leaderboard {
            padding: var(--spacing-xl);
            background: var(--bg-tertiary);
            margin-top: var(--spacing-lg);
        }
        .quiz-leaderboard h4 {
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
            font-size: var(--font-size-xl);
            text-align: center;
        }
        /* لوحة الإدارة */
        .admin-modal {
            width: 95vw;
            max-width: 1400px;
            height: 85vh;
        }
        .admin-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .admin-tabs {
            display: flex;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            gap: var(--spacing-sm);
            flex-wrap: wrap;
            background: var(--bg-tertiary);
        }
        .admin-tabs .tab-btn {
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 500;
        }
        .admin-tabs .tab-btn.active {
            background: var(--primary-color);
            color: var(--text-white);
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }
        .admin-tab {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-xl);
        }
        .admin-tab.active {
            display: block;
        }
        .admin-user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-lg);
            background: var(--bg-card);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            transition: var(--transition-fast);
        }
        .admin-user-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }
        .admin-user-info {
            display: flex;
            align-items: center;
        }
        .admin-user-avatar {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            margin-left: var(--spacing-md);
            border: 2px solid var(--primary-color);
            object-fit: cover;
        }
        .admin-user-details h4 {
            margin: 0 0 4px 0;
            color: var(--text-primary);
            font-weight: 600;
        }
        .admin-user-rank {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
        }
        .admin-user-actions {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
        .admin-action-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: var(--font-size-sm);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        /* إجراءات المستخدم */
        .user-actions {
            padding: var(--spacing-xl);
        }
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }
        .user-info img {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            margin-left: var(--spacing-md);
            border: 2px solid var(--primary-color);
            object-fit: cover;
        }
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spacing-xl);
            border: 2px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            text-decoration: none;
            text-align: center;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }
        .action-btn i {
            font-size: 1.8rem;
            margin-bottom: var(--spacing-sm);
        }
        .ban-btn:hover {
            background: var(--error-color);
            color: white;
            border-color: var(--error-color);
        }
        .mute-btn:hover {
            background: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }
        .rank-btn:hover {
            background: var(--info-color);
            color: white;
            border-color: var(--info-color);
        }
        .coins-btn:hover {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        /* نماذج الإجراءات */
        .ban-form,
        .rank-form,
        .room-form,
        .story-form {
            padding: var(--spacing-xl);
        }
        .form-group {
            margin-bottom: var(--spacing-lg);
        }
        .form-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
            font-weight: 600;
            font-size: var(--font-size-md);
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: var(--font-size-md);
            font-family: var(--font-family);
            transition: var(--transition-fast);
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            line-height: 1.6;
        }
        /* الرتب */
        .ranks-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--spacing-lg);
        }
        .rank-item {
            background: var(--bg-card);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            text-align: center;
            border: 2px solid var(--border-color);
            transition: var(--transition-fast);
            box-shadow: var(--shadow-light);
        }
        .rank-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-color);
        }
        .rank-emoji {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }
        .rank-name {
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-lg);
            color: var(--text-primary);
        }
        .rank-level {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
        }
        /* الراديو */
        .radio-stations {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }
        .station {
            display: flex;
            align-items: center;
            padding: var(--spacing-lg);
            background: var(--bg-card);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            border: 2px solid var(--border-color);
        }
        .station:hover {
            background: var(--primary-light);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }
        .station i {
            margin-left: var(--spacing-md);
            color: var(--primary-color);
            font-size: var(--font-size-lg);
        }
        .station span {
            font-weight: 500;
            color: var(--text-primary);
        }
        .radio-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            justify-content: center;
            padding: var(--spacing-lg);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }
        .custom-music {
            margin-top: var(--spacing-xl);
        }
        .custom-music h4 {
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
            font-size: var(--font-size-lg);
        }
        .custom-music-list {
            margin-top: var(--spacing-lg);
            max-height: 200px;
            overflow-y: auto;
        }
        /* ==================== إضافة قسم البحث عن الأغاني ==================== */
        .music-search-section {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-xl);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }
        .music-search-section h4 {
            margin-bottom: var(--spacing-lg);
            color: var(--text-primary);
            font-size: var(--font-size-lg);
            text-align: center;
        }
        .search-box {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }
        .search-box input {
            flex: 1;
            padding: var(--spacing-md);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: var(--font-size-md);
        }
        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .search-results {
            max-height: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        .search-result-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--bg-card);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            border: 1px solid var(--border-color);
        }
        .search-result-item:hover {
            background: var(--primary-light);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }
        .result-cover {
            width: 50px;
            height: 50px;
            border-radius: var(--radius-md);
            margin-left: var(--spacing-md);
            object-fit: cover;
        }
        .result-info {
            flex: 1;
            margin-right: var(--spacing-md);
        }
        .result-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }
        .result-artist {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        /* ==================== نهاية إضافة قسم البحث عن الأغاني ==================== */
        /* الأزرار */
        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: var(--font-size-sm);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            text-decoration: none;
            border: 2px solid transparent;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }
        .btn-primary {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: var(--text-white);
        }
        .btn-primary:hover {
            box-shadow: var(--shadow-glow);
        }
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        .btn-secondary:hover {
            background: var(--bg-card);
            border-color: var(--primary-color);
        }
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        .btn-danger,
        .btn-error {
            background: var(--error-color);
            color: white;
        }
        .btn-info {
            background: var(--info-color);
            color: white;
        }
        .save-btn {
            background: var(--success-color);
            color: white;
            padding: var(--spacing-md) var(--spacing-xl);
            font-weight: 600;
        }
        .like-btn {
            background: var(--error-color);
            color: white;
        }
        .message-btn {
            background: var(--primary-color);
            color: white;
        }
        /* التبديل */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--text-muted);
            transition: var(--transition-fast);
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            right: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--transition-fast);
            border-radius: 50%;
            box-shadow: var(--shadow-light);
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(-30px);
        }
        /* Loading Spinner */
        .loading-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-modal);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner p {
            margin-top: var(--spacing-lg);
            color: var(--text-secondary);
            font-size: var(--font-size-lg);
        }
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        .toast {
            background: var(--bg-card);
            color: var(--text-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-color);
            min-width: 300px;
            animation: toastSlideIn 0.4s ease;
            backdrop-filter: blur(10px);
        }
        .toast.success {
            border-right: 4px solid var(--success-color);
        }
        .toast.error {
            border-right: 4px solid var(--error-color);
        }
        .toast.warning {
            border-right: 4px solid var(--warning-color);
        }
        .toast.info {
            border-right: 4px solid var(--info-color);
        }
        @keyframes toastSlideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        /* تأثيرات الرتب */
        .rank-visitor { color: #888; }
        .rank-bronze { color: #cd7f32; }
        .rank-silver { color: #c0c0c0; }
        .rank-gold { color: #ffd700; }
        .rank-trophy { color: #ff6b35; }
        .rank-diamond { color: #b9f2ff; }
        .rank-prince { 
            background: linear-gradient(45deg, #ffd700, #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        .rank-admin {
            background: linear-gradient(45deg, #ff6b35, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        .rank-owner {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }
        /* تأثيرات زخرفة الأسماء */
        .name-decoration-fire {
            animation: fireEffect 2s infinite;
        }
        @keyframes fireEffect {
            0%, 100% { 
                text-shadow: 0 0 5px #ff6b35, 0 0 10px #ff6b35, 0 0 15px #ff6b35;
                color: #ff6b35;
            }
            50% { 
                text-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700, 0 0 30px #ffd700;
                color: #ffd700;
            }
        }
        .name-decoration-star {
            animation: starEffect 3s infinite;
        }
        @keyframes starEffect {
            0%, 100% { 
                text-shadow: 0 0 5px #ffd700;
                transform: scale(1);
            }
            50% { 
                text-shadow: 0 0 15px #ffd700, 0 0 25px #ffd700;
                transform: scale(1.05);
            }
        }
        .name-decoration-crown {
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
            font-weight: 700;
        }
        .name-decoration-diamond {
            animation: diamondEffect 2s infinite;
        }
        @keyframes diamondEffect {
            0%, 100% { 
                text-shadow: 0 0 5px #b9f2ff;
                color: #b9f2ff;
            }
            50% { 
                text-shadow: 0 0 15px #b9f2ff, 0 0 25px #b9f2ff;
                color: #ffffff;
            }
        }
        .name-decoration-rainbow {
            animation: rainbowEffect 3s infinite;
            font-weight: 700;
        }
        @keyframes rainbowEffect {
            0% { color: #ff0000; }
            16% { color: #ff8000; }
            33% { color: #ffff00; }
            50% { color: #00ff00; }
            66% { color: #0080ff; }
            83% { color: #8000ff; }
            100% { color: #ff0000; }
        }
        /* إخفاء العناصر المخصصة للأدوار */
        .admin-only {
            display: none;
        }
        .owner-only {
            display: none;
        }
        .moderator-only {
            display: none;
        }
        /* عرض العناصر حسب الدور */
        [data-user-role="admin"] .admin-only,
        [data-user-role="admin"] .moderator-only {
            display: block;
        }
        [data-user-role="owner"] .owner-only,
        [data-user-role="owner"] .admin-only,
        [data-user-role="owner"] .moderator-only {
            display: block;
        }
        [data-user-role="moderator"] .moderator-only {
            display: block;
        }
        /* رسائل الخطأ */
        .error-message {
            background: var(--error-color);
            color: white;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-lg);
            text-align: center;
            display: none;
            animation: shake 0.5s ease;
        }
        .error-message.show {
            display: block;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        /* الاستجابة للشاشات الصغيرة */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            .users-sidebar {
                width: 100%;
                height: 200px;
                order: 2;
            }
            .chat-area {
                order: 1;
                min-height: 60vh;
            }
            .header-right {
                gap: var(--spacing-xs);
            }
            .header-btn {
                width: 36px;
                height: 36px;
            }
            .modal-content {
                width: 95vw;
                height: 90vh;
                margin: 5vh auto;
            }
            .profile-modal {
                width: 95vw;
            }
            .profile-avatars {
                flex-direction: column;
                align-items: center;
                gap: var(--spacing-lg);
            }
            .admin-modal {
                width: 95vw;
                height: 90vh;
            }
            .admin-tabs {
                flex-wrap: wrap;
            }
            .ranks-list {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            .menu-items {
                grid-template-columns: 1fr;
            }
            .actions-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .profile-stats {
                gap: var(--spacing-lg);
            }
            .stat-item {
                min-width: 80px;
            }
            .header-center {
                display: none;
            }
            .app-logo h1 {
                font-size: var(--font-size-lg);
            }
            .user-profile-mini {
                padding: var(--spacing-xs);
            }
            .user-avatar-mini {
                width: 32px;
                height: 32px;
            }
            .message-content {
                max-width: 85%;
            }
            .input-tools {
                flex-wrap: wrap;
            }
            .tool-btn {
                width: 36px;
                height: 36px;
            }
            .bottom-control-bar {
                flex-wrap: wrap;
                gap: var(--spacing-sm);
            }
            .login-container {
                margin: var(--spacing-md);
                padding: var(--spacing-xl);
            }
            .ban-container {
                margin: var(--spacing-md);
                padding: var(--spacing-xl);
            }
        }
        @media (max-width: 480px) {
            .profile-tabs {
                flex-wrap: wrap;
            }
            .profile-tabs .tab-btn {
                flex: 1;
                min-width: 120px;
            }
            .news-form-actions {
                flex-direction: column;
                align-items: stretch;
            }
            .question-options {
                grid-template-columns: 1fr;
            }
            .quiz-stats {
                flex-direction: column;
                gap: var(--spacing-md);
            }
            .radio-controls {
                flex-direction: column;
                gap: var(--spacing-md);
            }
        }
        /* تحسينات إضافية للأداء */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        img {
            max-width: 100%;
            height: auto;
        }
        video {
            max-width: 100%;
            height: auto;
        }
        /* تحسينات إمكانية الوصول */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        /* تأثيرات التمرير */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: var(--radius-sm);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        /* تأثيرات التحديد */
        ::selection {
            background: var(--primary-light);
            color: var(--text-primary);
        }
        ::-moz-selection {
            background: var(--primary-light);
            color: var(--text-primary);
        }
        /* أنماط الميزات الجديدة */
        /* أنماط صندوق الدردشة الخاصة */
        .private-chat-box {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 350px;
            height: 500px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            animation: slideInLeft 0.3s ease;
        }
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .chat-box-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: var(--primary-color);
            color: var(--text-white);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            backdrop-filter: blur(10px);
        }
        .chat-box-title {
            font-weight: 600;
            font-size: var(--font-size-md);
        }
        .chat-box-controls {
            display: flex;
            gap: var(--spacing-sm);
        }
        .chat-box-btn {
            padding: var(--spacing-xs);
            border: none;
            background: transparent;
            color: var(--text-white);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition-fast);
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-box-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        .chat-box-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
        }
        .private-chat-users {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }
        .private-chat-users select {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }
        .private-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
            max-height: 300px;
        }
        .private-message {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }
        .private-message.own {
            background: var(--primary-light);
            border-color: var(--primary-color);
            margin-right: var(--spacing-lg);
        }
        .private-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xs);
        }
        .private-message-author {
            font-weight: 600;
            color: var(--primary-color);
            font-size: var(--font-size-sm);
        }
        .private-message-time {
            font-size: var(--font-size-xs);
            color: var(--text-muted);
        }
        .private-message-text {
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            line-height: 1.4;
        }
        .private-chat-input {
            display: flex;
            padding: var(--spacing-md);
            border-top: 1px solid var(--border-color);
            gap: var(--spacing-sm);
        }
        .private-chat-input input {
            flex: 1;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
        }
        .private-chat-input input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(233, 30, 99, 0.1);
        }
        .private-chat-send {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            background: var(--primary-color);
            color: var(--text-white);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .private-chat-send:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        /* أنماط رفع الصور */
        .upload-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .upload-progress-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .upload-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* أنماط معاينة يوتيوب */
        .youtube-embed {
            background: #000;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
        }
        .youtube-embed iframe {
            border-radius: 8px;
        }
        .youtube-info {
            color: #fff;
            margin-top: 8px;
            font-size: 14px;
        }
        /* أنماط الرسائل المحذوفة */
        .deleted-message {
            opacity: 0.5;
            font-style: italic;
            color: #999;
            background: rgba(231, 76, 60, 0.1) !important;
        }
        /* أنماط مودال إنشاء الغرف */
        .room-form, .contest-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-group label {
            font-weight: bold;
            color: #2c3e50;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .room-actions, .contest-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        /* أزرار رفع الملفات */
        .file-upload-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .file-upload-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .file-upload-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .emoji-toggle-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .emoji-toggle-btn:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }
        /* أنماط الإيموجي المتحركة */
        .animated-emoji {
            display: inline-block;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s ease;
            padding: 5px;
            border-radius: 50%;
        }
        .animated-emoji:hover {
            transform: scale(1.3);
            background: rgba(52, 152, 219, 0.1);
        }
        .emoji-panel {
            position: absolute;
            bottom: 60px;
            right: 10px;
            background: white;
            border: 2px solid #3498db;
            border-radius: 15px;
            padding: 15px;
            max-width: 300px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        /* تأثيرات الإيموجي المتحركة */
        .animated-emoji.laugh {
            animation: bounce 0.6s ease-in-out infinite alternate;
        }
        .animated-emoji.heart-eyes {
            animation: pulse 1s ease-in-out infinite;
        }
        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-10px); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* ==================== إضافة أنماط سجل الرقابة (Audit Log) ==================== */
        .audit-log-list {
            max-height: 500px;
            overflow-y: auto;
            padding: var(--spacing-lg);
        }
        .audit-item {
            background: var(--bg-card);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            border-left: 4px solid var(--primary-color);
            font-size: var(--font-size-sm);
            transition: var(--transition-fast);
        }
        .audit-item:hover {
            background: var(--primary-light);
            transform: translateX(5px);
        }
        .timestamp {
            color: var(--text-muted);
            font-weight: 500;
        }
        .admin {
            color: var(--info-color);
            font-weight: 600;
        }
        .action {
            color: var(--text-primary);
        }
        /* ==================== نهاية إضافة أنماط سجل الرقابة ==================== */

        /* ==================== تأثير عند الكتم ==================== */
        .user-status.muted {
            color: var(--warning-color);
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        /* ==================== نهاية تأثير الكتم ==================== */

        /* ==================== تأثير عند التلميح في المسابقة ==================== */
        .hint-section.show {
            animation: fadeIn 0.5s ease;
        }
        /* ==================== نهاية تأثير التلميح ==================== */

        /* ==================== تأثير عند تشغيل الأغنية من البحث ==================== */
        .now-playing.active {
            background: var(--primary-light);
            color: var(--primary-color);
            font-weight: bold;
            animation: pulse 1s infinite;
        }
        /* ==================== نهاية تأثير تشغيل الأغنية ==================== */
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول -->
    <div id="loginScreen" class="screen active">
        <div class="login-container">
            <div class="login-header">
                <div class="logo">
                    <h1>🦂 شات وتين العقرب</h1>
                    <p>منصة التواصل الاجتماعي الأولى</p>
                </div>
            </div>
            <div class="login-tabs">
                <button class="tab-btn active" onclick="showLoginTab('login')">
                    <i class="fas fa-sign-in-alt"></i>
                    تسجيل الدخول
                </button>
                <button class="tab-btn" onclick="showLoginTab('register')">
                    <i class="fas fa-user-plus"></i>
                    إنشاء حساب
                </button>
                <button class="tab-btn" onclick="showLoginTab('guest')">
                    <i class="fas fa-user-secret"></i>
                    دخول كزائر
                </button>
                <!-- إضافة دخول عبر Google/Facebook حسب المواصفات -->
                <div class="social-login">
                    <button class="social-btn google" onclick="loginWithGoogle()">
                        <i class="fab fa-google"></i> Google
                    </button>
                    <button class="social-btn facebook" onclick="loginWithFacebook()">
                        <i class="fab fa-facebook-f"></i> Facebook
                    </button>
                </div>
            </div>
            <!-- تسجيل الدخول -->
            <form id="loginForm" class="auth-form active">
                <div class="input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="loginEmail" placeholder="البريد الإلكتروني" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="loginPassword" placeholder="كلمة المرور" required>
                </div>
                <button type="submit" class="auth-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    دخول
                </button>
            </form>
            <!-- إنشاء حساب -->
            <form id="registerForm" class="auth-form">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="registerDisplayName" placeholder="الاسم المعروض" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="registerEmail" placeholder="البريد الإلكتروني" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="registerPassword" placeholder="كلمة المرور" required>
                </div>
                <button type="submit" class="auth-btn">
                    <i class="fas fa-user-plus"></i>
                    إنشاء حساب
                </button>
            </form>
            <!-- دخول كزائر -->
            <form id="guestForm" class="auth-form">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="guestName" placeholder="الاسم المستخدم" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-birthday-cake"></i>
                    <input type="number" id="guestAge" placeholder="العمر" min="13" max="99" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-venus-mars"></i>
                    <select id="guestGender" required>
                        <option value="">اختر الجنس</option>
                        <option value="ذكر">ذكر</option>
                        <option value="أنثى">أنثى</option>
                        <option value="آخر">آخر</option>
                    </select>
                </div>
                <button type="submit" class="auth-btn">
                    <i class="fas fa-user-secret"></i>
                    دخول كزائر
                </button>
            </form>
            <div id="loginError" class="error-message"></div>
        </div>
    </div>

    <!-- شاشة الحظر -->
    <div id="banScreen" class="screen">
        <div class="ban-container">
            <div class="ban-icon">🚫</div>
            <h2>تم حظرك من الدخول</h2>
            <div id="banReason" class="ban-reason">
                <p>لم يتم تحديد سبب الحظر</p>
            </div>
            <div class="contact-info">
                <p>للتواصل والاستفسار:</p>
                <a href="mailto:njdj9985@gmail.com">njdj9985@gmail.com</a>
            </div>
            <button onclick="checkBanStatus()" class="btn btn-primary">
                <i class="fas fa-sync-alt"></i>
                التحقق من حالة الحظر
            </button>
        </div>
    </div>

    <!-- الشاشة الرئيسية -->
    <div id="mainScreen" class="screen">
        <!-- الشريط العلوي -->
        <header class="main-header">
            <div class="header-left">
                <button class="hamburger-btn" onclick="openMainMenu()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="app-logo">
                    <h1>🦂 شات وتين العقرب</h1>
                </div>
            </div>
            <div class="header-center">
                <div class="room-selector">
                    <select id="roomSelect" onchange="changeRoom()">
                        <option value="1">الغرفة الرئيسية</option>
                        <!-- سيتم ملؤها ديناميكيًا بالجافاسكريبت -->
                    </select>
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn" onclick="openNotifications()" title="الإشعارات">
                    <i class="fas fa-bell"></i>
                    <span id="notificationCount" class="notification-badge">0</span>
                </button>
                <button class="header-btn" onclick="openSettings()" title="الإعدادات">
                    <i class="fas fa-cog"></i>
                </button>
                <div class="user-profile-mini" onclick="openProfileModal()">
                    <img id="headerUserAvatar" class="user-avatar-mini" src="https://images.pexels.com/photos/771742/pexels-photo-771742.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop" alt="">
                    <div class="user-info-mini">
                        <span id="headerUserName" class="user-name">المستخدم</span>
                        <span id="headerUserRank" class="user-rank">زائر</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- المحتوى الرئيسي -->
        <main class="main-content">
            <!-- منطقة الدردشة -->
            <div class="chat-area">
                <div class="chat-header">
                    <h2 id="currentRoomName">الغرفة الرئيسية</h2>
                    <div class="chat-controls">
                        <button class="control-btn" onclick="toggleChatMode()" title="تبديل وضع الدردشة">
                            <i class="fas fa-exchange-alt"></i>
                            <span id="chatModeText">عام</span>
                        </button>
                        <button class="control-btn" onclick="clearChat()" title="مسح الدردشة" id="clearChatBtn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div id="messagesContainer" class="messages-container">
                    <div class="welcome-message">
                        <div class="welcome-content">
                            <h3>🦂 مرحباً بك في شات وتين العقرب</h3>
                            <p>ابدأ محادثة جديدة أو انضم للمحادثات الجارية</p>
                        </div>
                    </div>
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>
                <div class="message-input-container">
                    <div class="input-tools">
                        <button class="tool-btn" onclick="document.getElementById('imageInput').click()" title="إرسال صورة">
                            <i class="fas fa-image"></i>
                        </button>
                        <button class="tool-btn" onclick="toggleVoiceRecording()" title="تسجيل صوتي" id="voiceBtn">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="tool-btn" onclick="openEmojiPicker()" title="الرموز التعبيرية">
                            <i class="fas fa-smile"></i>
                        </button>
                        <button class="tool-btn" onclick="openGifPicker()" title="صور متحركة">
                            <i class="fas fa-magic"></i>
                        </button>
                    </div>
                    <div class="message-input-wrapper">
                        <div class="quoted-message" id="quotedMessage" style="display: none;">
                            <div class="quoted-content">
                                <span class="quoted-author"></span>
                                <span class="quoted-text"></span>
                            </div>
                            <button class="cancel-quote" onclick="cancelQuote()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <input type="text" id="messageInput" placeholder="اكتب رسالتك هنا..." maxlength="1000">
                        <button class="send-btn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    <input type="file" id="voiceInput" accept="audio/*" style="display: none;">
                </div>
            </div>

            <!-- الشريط الجانبي للمستخدمين -->
            <aside class="users-sidebar">
                <div class="sidebar-header">
                    <h3>المتصلون الآن</h3>
                    <span id="onlineCount" class="online-count">0</span>
                </div>
                <div id="onlineUsersList" class="users-list">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>
            </aside>
        </main>

        <!-- شريط التحكم السفلي -->
        <div class="bottom-control-bar">
            <button class="control-btn" onclick="reloadPage()" title="تحديث الصفحة">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="control-btn" onclick="openRadioPlayer()" title="الراديو">
                <i class="fas fa-radio"></i>
            </button>
            <div class="music-controls">
                <button class="control-btn" onclick="toggleMusicPlayer()" title="مشغل الموسيقى" id="musicToggle">
                    <i class="fas fa-music"></i>
                </button>
                <div class="volume-control">
                    <i class="fas fa-volume-up"></i>
                    <input type="range" id="volumeSlider" min="0" max="100" value="50">
                </div>
            </div>
            <div class="now-playing" id="nowPlaying">
                <span class="song-title">لا يوجد تشغيل</span>
                <!-- سيتم تحديثه بالجافاسكريبت -->
            </div>
        </div>
    </div>

    <!-- القائمة الرئيسية -->
    <div id="mainMenuModal" class="modal">
        <div class="modal-content main-menu">
            <div class="modal-header">
                <h2>القائمة الرئيسية</h2>
                <button class="close-btn" onclick="closeMainMenu()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="menu-items">
                <div class="menu-item" onclick="openNewsSection()">
                    <i class="fas fa-newspaper"></i>
                    <span>الأخبار</span>
                    <p>انشر الأخبار والتحديثات</p>
                </div>
                <div class="menu-item" onclick="openStoriesSection()">
                    <i class="fas fa-images"></i>
                    <span>القصص اليومية</span>
                    <p>شارك قصتك اليومية</p>
                </div>
                <div class="menu-item" onclick="openSendNotificationModal()">
                    <i class="fas fa-bell"></i>
                    <span>إرسال إشعار</span>
                    <p>إرسال إشعار لأي شخص</p>
                </div>
                <div class="menu-item" onclick="openOnlineUsersModal()">
                    <i class="fas fa-users"></i>
                    <span>المتصلين حالياً</span>
                    <p>عرض قائمة المتصلين</p>
                </div>
                <div class="menu-item" onclick="openPrivateChatBox()">
                    <i class="fas fa-comment-dots"></i>
                    <span>صندوق الدردشة</span>
                    <p>دردشة خاصة منفصلة</p>
                </div>
                <div class="menu-item" onclick="openGamesSection()">
                    <i class="fas fa-gamepad"></i>
                    <span>الألعاب</span>
                    <p>العب مع الأصدقاء</p>
                </div>
                <div class="menu-item" onclick="openQuizRoom()">
                    <i class="fas fa-question-circle"></i>
                    <span>غرفة المسابقات</span>
                    <p>اختبر معلوماتك واربح النقاط</p>
                </div>
                <div class="menu-item" onclick="openRoomsManager()" id="roomsManagerBtn">
                    <i class="fas fa-door-open"></i>
                    <span>إدارة الغرف</span>
                    <p>إنشاء وإدارة الغرف</p>
                </div>
                <div class="menu-item" onclick="openCoinsShop()">
                    <i class="fas fa-coins"></i>
                    <span>متجر النقاط</span>
                    <p>اشتري المميزات بالنقاط</p>
                </div>
                <div class="menu-item" onclick="openAdminPanel()" id="adminPanelBtn">
                    <i class="fas fa-crown"></i>
                    <span>لوحة الإدارة</span>
                    <p>إدارة المستخدمين والنظام</p>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال الملف الشخصي -->
    <div id="profileModal" class="modal">
        <div class="modal-content profile-modal">
            <div class="modal-header">
                <h2>الملف الشخصي</h2>
                <button class="close-btn" onclick="closeProfileModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="profile-content">
                <div class="profile-cover">
                    <img id="profileCover" src="https://images.pexels.com/photos/1323550/pexels-photo-1323550.jpeg?auto=compress&cs=tinysrgb&w=800&h=300&fit=crop" alt="خلفية البروفايل">
                    <input type="file" id="coverInput" accept="image/*" style="display: none;">
                    <button class="change-cover-btn" onclick="document.getElementById('coverInput').click()">
                        <i class="fas fa-camera"></i>
                        تغيير الخلفية
                    </button>
                </div>
                <div class="profile-info">
                    <div class="profile-avatar-section">
                        <div class="profile-avatars">
                            <div class="avatar-slot">
                                <img id="profileImg1" src="https://images.pexels.com/photos/771742/pexels-photo-771742.jpeg?auto=compress&cs=tinysrgb&w=150&h=150&fit=crop" alt="صورة 1">
                                <input type="file" id="profileFile1" accept="image/*" style="display: none;">
                                <button onclick="document.getElementById('profileFile1').click()">
                                    <i class="fas fa-camera"></i>
                                </button>
                            </div>
                            <div class="avatar-slot">
                                <img id="profileImg2" src="https://images.pexels.com/photos/1040880/pexels-photo-1040880.jpeg?auto=compress&cs=tinysrgb&w=150&h=150&fit=crop" alt="صورة 2">
                                <input type="file" id="profileFile2" accept="image/*" style="display: none;">
                                <button onclick="document.getElementById('profileFile2').click()">
                                    <i class="fas fa-camera"></i>
                                </button>
                            </div>
                        </div>
                        <div class="profile-stats">
                            <div class="stat-item">
                                <span class="stat-number" id="profileLikes">0</span>
                                <span class="stat-label">إعجاب</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="profileCoins">2000</span>
                                <span class="stat-label">نقطة</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="profileRank">زائر</span>
                                <span class="stat-label">الرتبة</span>
                            </div>
                        </div>
                    </div>
                    <div class="profile-details">
                        <div class="profile-tabs">
                            <button class="tab-btn active" onclick="showProfileTab('info')">
                                <i class="fas fa-info-circle"></i>
                                المعلومات
                            </button>
                            <button class="tab-btn" onclick="showProfileTab('settings')">
                                <i class="fas fa-cog"></i>
                                الإعدادات
                            </button>
                            <button class="tab-btn" onclick="showProfileTab('music')">
                                <i class="fas fa-music"></i>
                                الموسيقى
                            </button>
                            <button class="tab-btn" onclick="showProfileTab('decorations')">
                                <i class="fas fa-palette"></i>
                                الزخارف
                            </button>
                        </div>

                        <!-- تبويب المعلومات -->
                        <div id="profileInfoTab" class="profile-tab active">
                            <div class="info-section">
                                <label>الاسم المعروض:</label>
                                <input type="text" id="displayNameInput" placeholder="اسمك المعروض">
                            </div>
                            <div class="info-section">
                                <label>البريد الإلكتروني:</label>
                                <input type="email" id="emailInput" placeholder="بريدك الإلكتروني">
                            </div>
                            <div class="info-section">
                                <label>كلمة المرور الجديدة:</label>
                                <input type="password" id="newPasswordInput" placeholder="كلمة المرور الجديدة">
                            </div>
                            <div class="info-section">
                                <label>العمر:</label>
                                <input type="number" id="ageInput" min="13" max="100">
                            </div>
                            <div class="info-section">
                                <label>الجنس:</label>
                                <select id="genderInput">
                                    <option value="">غير محدد</option>
                                    <option value="ذكر">ذكر</option>
                                    <option value="أنثى">أنثى</option>
                                </select>
                            </div>
                            <div class="info-section">
                                <label>الحالة الاجتماعية:</label>
                                <select id="maritalStatusInput">
                                    <option value="">غير محدد</option>
                                    <option value="أعزب">أعزب</option>
                                    <option value="مرتبط">مرتبط</option>
                                    <option value="متزوج">متزوج</option>
                                </select>
                            </div>
                            <div class="info-section">
                                <label>نبذة عني:</label>
                                <textarea id="aboutMeInput" placeholder="اكتب شيئاً عن نفسك..."></textarea>
                            </div>
                            <button onclick="updateProfile()" class="btn save-btn">
                                <i class="fas fa-save"></i>
                                حفظ التغييرات
                            </button>
                        </div>

                        <!-- تبويب الإعدادات -->
                        <div id="profileSettingsTab" class="profile-tab">
                            <div class="settings-section">
                                <h4>لون الاسم</h4>
                                <input type="color" id="nameColorPicker" value="#ffffff">
                                <button onclick="updateNameColor()" class="btn">تطبيق اللون</button>
                            </div>
                            <div class="settings-section">
                                <h4>لون الخط</h4>
                                <input type="color" id="fontColorPicker" value="#000000">
                                <button onclick="updateFontColor()" class="btn">تطبيق اللون</button>
                            </div>
                            <div class="settings-section">
                                <h4>خلفية الرسائل</h4>
                                <input type="file" id="messageBackgroundInput" accept="image/*">
                                <button onclick="uploadMessageBackground()" class="btn">تحديث الخلفية</button>
                            </div>
                        </div>

                        <!-- تبويب الموسيقى -->
                        <div id="profileMusicTab" class="profile-tab">
                            <div class="music-section">
                                <h4>موسيقى البروفايل</h4>
                                <input type="file" id="profileMusicInput" accept="audio/*">
                                <div id="currentMusic" class="current-music">
                                    <audio id="profileAudio" controls></audio>
                                </div>
                                <button onclick="uploadProfileMusic()" class="btn">رفع موسيقى</button>
                                <button onclick="removeProfileMusic()" class="btn btn-danger">إزالة الموسيقى</button>
                                <p class="feature-note">متاح للرتب العالية فقط</p>
                            </div>
                        </div>

                        <!-- تبويب الزخارف -->
                        <div id="profileDecorationsTab" class="profile-tab">
                            <div class="decorations-section">
                                <h4>زخرفة الاسم</h4>
                                <select id="nameDecorationSelect">
                                    <option value="">بدون زخرفة</option>
                                    <option value="fire">نار 🔥</option>
                                    <option value="star">نجوم ⭐</option>
                                    <option value="crown">تاج 👑</option>
                                    <option value="diamond">ماس 💎</option>
                                    <option value="rainbow">قوس قزح 🌈</option>
                                </select>
                                <button onclick="updateNameDecoration()" class="btn">تطبيق الزخرفة</button>
                                <p class="feature-note">بعض الزخارف متاحة للرتب العالية فقط</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال عرض ملف شخصي آخر -->
    <div id="viewProfileModal" class="modal">
        <div class="modal-content profile-modal">
            <div class="modal-header">
                <h2 id="viewProfileName">الملف الشخصي</h2>
                <button class="close-btn" onclick="closeViewProfileModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="profile-content">
                <div class="profile-cover">
                    <img id="viewProfileCover" src="" alt="خلفية البروفايل">
                </div>
                <div class="profile-info">
                    <div class="profile-avatar-section">
                        <div class="profile-avatars">
                            <div class="avatar-slot">
                                <img id="viewProfileImg1" src="" alt="صورة 1">
                            </div>
                            <div class="avatar-slot">
                                <img id="viewProfileImg2" src="" alt="صورة 2">
                            </div>
                        </div>
                        <div class="profile-stats">
                            <div class="stat-item">
                                <span class="stat-number" id="viewProfileLikes">0</span>
                                <span class="stat-label">إعجاب</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number" id="viewProfileCoins">0</span>
                                <span class="stat-label">نقطة</span>
                            </div>
                        </div>
                        <div class="profile-actions">
                            <button onclick="likeProfile()" class="btn like-btn">
                                <i class="fas fa-heart"></i> إعجاب
                            </button>
                            <button onclick="startPrivateChat()" class="btn message-btn">
                                <i class="fas fa-envelope"></i> رسالة
                            </button>
                        </div>
                    </div>
                    <div class="profile-details">
                        <div id="viewProfileInfo" class="profile-info-display">
                            <!-- سيتم ملؤها بالجافاسكريبت -->
                        </div>
                        <div id="viewProfileMusic" class="profile-music-display">
                            <!-- موسيقى البروفايل -->
                            <audio id="viewProfileAudio" controls style="width: 100%; margin-top: 10px;"></audio>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال الأخبار -->
    <div id="newsModal" class="modal">
        <div class="modal-content news-modal">
            <div class="modal-header">
                <h2>📰 قناة الأخبار</h2>
                <button class="close-btn" onclick="closeNewsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="news-content">
                <div class="news-post-form">
                    <textarea id="newsContentInput" placeholder="اكتب خبرًا..." maxlength="500"></textarea>
                    <div class="news-form-actions">
                        <input type="file" id="newsFileInput" accept="image/*,video/*" style="display: none;">
                        <button onclick="document.getElementById('newsFileInput').click()" class="btn btn-secondary">
                            <i class="fas fa-image"></i>
                            اختر صورة أو فيديو
                        </button>
                        <button onclick="postNews()" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                            نشر
                        </button>
                    </div>
                </div>
                <div id="newsFeed" class="news-feed">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                    <!--
                    <div class="news-post">
                        <div class="post-header">
                            <img src="avatar.jpg" class="post-avatar">
                            <div class="post-info">
                                <span class="post-author">اسم المستخدم</span>
                                <span class="post-time">منذ 5 دقائق</span>
                            </div>
                        </div>
                        <div class="post-content">
                            <p>هذا مثال على منشور إخباري...</p>
                            <img src="post-image.jpg" class="post-image">
                        </div>
                        <div class="post-reactions">
                            <button class="reaction-btn" data-reaction="like"><i class="fas fa-thumbs-up"></i> <span>12</span></button>
                            <button class="reaction-btn" data-reaction="love"><i class="fas fa-heart"></i> <span>5</span></button>
                            <button class="reaction-btn" data-reaction="laugh"><i class="fas fa-laugh"></i> <span>3</span></button>
                            <button class="reaction-btn" data-reaction="dislike"><i class="fas fa-thumbs-down"></i> <span>1</span></button>
                        </div>
                        <div class="post-comments">
                            <div class="comment">
                                <span class="comment-author">مستخدم1:</span>
                                <span class="comment-text">تعليق رائع!</span>
                            </div>
                            <div class="comment">
                                <span class="comment-author">مستخدم2:</span>
                                <span class="comment-text">أوافق!</span>
                            </div>
                            <div class="add-comment">
                                <input type="text" placeholder="أضف تعليق...">
                                <button>إرسال</button>
                            </div>
                        </div>
                    </div>
                    -->
                </div>
            </div>
        </div>
    </div>

    <!-- مودال القصص -->
    <div id="storiesModal" class="modal">
        <div class="modal-content stories-modal">
            <div class="modal-header">
                <h2>📸 القصص اليومية</h2>
                <button class="close-btn" onclick="closeStoriesModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="stories-content">
                <div class="add-story-section">
                    <button onclick="openAddStoryModal()" class="btn add-story-btn">
                        <i class="fas fa-plus"></i> إضافة قصة
                    </button>
                </div>
                <div id="storiesContainer" class="stories-container">
                    <!-- سيتم ملؤها بالجافاسكريبت -->
                </div>
            </div>
        </div>
    </div>

    <!-- مودال إضافة قصة -->
    <div id="addStoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>إضافة قصة جديدة</h2>
                <button class="close-btn" onclick="closeAddStoryModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="story-form">
                <input type="file" id="storyMediaInput" accept="image/*,video/*" required>
                <textarea id="storyTextInput" placeholder="نص القصة (اختياري)"></textarea>
                <button onclick="addStory()" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    إضافة القصة
                </button>
            </div>
        </div>
    </div>

    <!-- مودال غرفة المسابقات -->
    <div id="quizRoomModal" class="modal">
        <div class="modal-content quiz-room-modal">
            <div class="modal-header">
                <h2>🏆 غرفة المسابقات</h2>
                <button class="close-btn" onclick="closeQuizRoom()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="quiz-content">
                <div class="quiz-stats">
                    <div class="stat-item">
                        <span>نقاطك:</span>
                        <span id="userQuizPoints">0</span>
                    </div>
                    <div class="stat-item">
                        <span>الترتيب:</span>
                        <span id="userQuizRank">#-</span>
                    </div>
                </div>
                <div id="quizQuestion" class="quiz-question">
                    <h3 id="questionText">مرحباً بك في غرفة المسابقات!</h3>
                    <div id="questionOptions" class="question-options">
                        <!-- سيتم ملؤها بالجافاسكريبت -->
                        <!--
                        <button class="option-btn" onclick="selectAnswer('A')">A. الإجابة الأولى</button>
                        <button class="option-btn" onclick="selectAnswer('B')">B. الإجابة الثانية</button>
                        <button class="option-btn" onclick="selectAnswer('C')">C. الإجابة الثالثة</button>
                        <button class="option-btn" onclick="selectAnswer('D')">D. الإجابة الرابعة</button>
                        -->
                    </div>
                    <div class="quiz-timer">
                        <span>الوقت المتبقي: </span>
                        <span id="quizTimer">15</span> <!-- تم تعديله من 30 إلى 15 حسب المواصفات -->
                        <span> ثانية</span>
                    </div>
                    <div id="hintSection" class="hint-section" style="display: none; margin-top: 10px; color: #ff9800;">
                        <i class="fas fa-lightbulb"></i> <span id="hintText">تلميح: ...</span>
                    </div>
                </div>
                <div id="quizLeaderboard" class="quiz-leaderboard">
                    <h4>لوحة المتصدرين</h4>
                    <div id="leaderboardList">
                        <!-- سيتم ملؤها بالجافاسكريبت -->
                        <!--
                        <div class="leaderboard-item">
                            <span class="rank">1.</span>
                            <span class="username">اللاعب الأول</span>
                            <span class="score">150</span>
                        </div>
                        -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال لوحة الإدارة -->
    <div id="adminModal" class="modal">
        <div class="modal-content admin-modal">
            <div class="modal-header">
                <h2>👑 لوحة الإدارة</h2>
                <button class="close-btn" onclick="closeAdminModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="admin-content">
                <div class="admin-tabs">
                    <button class="tab-btn active" onclick="showAdminTab('users')">
                        <i class="fas fa-users"></i>
                        إدارة المستخدمين
                    </button>
                    <button class="tab-btn" onclick="showAdminTab('ranks')">
                        <i class="fas fa-crown"></i>
                        الرتب
                    </button>
                    <button class="tab-btn" onclick="showAdminTab('rooms')">
                        <i class="fas fa-door-open"></i>
                        الغرف
                    </button>
                    <button class="tab-btn" onclick="showAdminTab('bans')">
                        <i class="fas fa-ban"></i>
                        الحظر والكتم
                    </button>
                    <button class="tab-btn" onclick="showAdminTab('coins')">
                        <i class="fas fa-coins"></i>
                        النقاط
                    </button>
                    <button class="tab-btn" onclick="showAdminTab('notifications')">
                        <i class="fas fa-bell"></i>
                        الإشعارات
                    </button>
                    <button class="tab-btn" onclick="showAdminTab('audit')">
                        <i class="fas fa-clipboard-list"></i>
                        سجل الرقابة
                    </button>
                </div>

                <!-- تبويب إدارة المستخدمين -->
                <div id="adminUsersTab" class="admin-tab active">
                    <div class="admin-actions">
                        <button onclick="refreshUsersList()" class="btn">
                            <i class="fas fa-sync-alt"></i>
                            تحديث القائمة
                        </button>
                    </div>
                    <div id="adminUsersList" class="admin-users-list">
                        <!-- سيتم ملؤها بالجافاسكريبت -->
                    </div>
                </div>

                <!-- تبويب الرتب -->
                <div id="adminRanksTab" class="admin-tab">
                    <div class="ranks-management">
                        <div class="actions-bar">
                            <button onclick="openCreateRankModal()" class="btn btn-primary">
                                <i class="fas fa-plus"></i> إنشاء رتبة جديدة
                            </button>
                        </div>
                        <h3>الرتب المتاحة</h3>
                        <div id="ranksList" class="ranks-list">
                            <!-- سيتم ملؤها بالجافاسكريبت -->
                        </div>
                    </div>
                </div>

                <!-- تبويب الغرف -->
                <div id="adminRoomsTab" class="admin-tab">
                    <div class="rooms-management">
                        <button onclick="openCreateRoomModal()" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            إنشاء غرفة جديدة
                        </button>
                        <div id="adminRoomsList" class="admin-rooms-list">
                            <!-- سيتم ملؤها بالجافاسكريبت -->
                        </div>
                    </div>
                </div>

                <!-- تبويب الحظر والكتم -->
                <div id="adminBansTab" class="admin-tab">
                    <div class="bans-management">
                        <h3>المستخدمون المحظورون</h3>
                        <div id="bannedUsersList" class="banned-users-list">
                            <!-- سيتم ملؤها بالجافاسكريبت -->
                        </div>
                        <h3 style="margin-top: 20px;">المستخدمون المكتومون</h3>
                        <div id="mutedUsersList" class="banned-users-list">
                            <!-- سيتم ملؤها بالجافاسكريبت -->
                        </div>
                    </div>
                </div>

                <!-- تبويب النقاط -->
                <div id="adminCoinsTab" class="admin-tab">
                    <div class="coins-management">
                        <h3>إدارة النقاط</h3>
                        <div class="coins-form">
                            <select id="coinsUserSelect">
                                <option value="">اختر المستخدم</option>
                            </select>
                            <input type="number" id="coinsAmount" placeholder="عدد النقاط">
                            <button onclick="giveCoins()" class="btn btn-primary">
                                <i class="fas fa-coins"></i>
                                إعطاء نقاط
                            </button>
                        </div>
                    </div>
                </div>

                <!-- تبويب الإشعارات -->
                <div id="adminNotificationsTab" class="admin-tab">
                    <div class="notifications-management">
                        <h3>إرسال إشعارات</h3>
                        <div class="notification-form">
                            <select id="notificationTarget">
                                <option value="all">للجميع</option>
                                <option value="specific">لمستخدم محدد</option>
                            </select>
                            <select id="specificUserSelect" style="display: none;">
                                <option value="">اختر المستخدم</option>
                            </select>
                            <textarea id="notificationMessage" placeholder="نص الإشعار"></textarea>
                            <button onclick="sendNotification()" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                                إرسال الإشعار
                            </button>
                        </div>
                    </div>
                </div>

                <!-- تبويب سجل الرقابة (جديد حسب المواصفات) -->
                <div id="adminAuditTab" class="admin-tab">
                    <div class="audit-management">
                        <h3>سجل الرقابة (Audit Log)</h3>
                        <div id="auditLogList" class="audit-log-list">
                            <!-- سيتم ملؤها بالجافاسكريبت -->
                            <!--
                            <div class="audit-item">
                                <span class="timestamp">[2024-06-15 14:30]</span>
                                <span class="admin">[المشرف: أحمد]</span>
                                <span class="action">حظر المستخدم [محمد] بسبب [إساءة استخدام]</span>
                            </div>
                            -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال إجراءات المستخدم -->
    <div id="userActionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>إجراءات المستخدم</h2>
                <button class="close-btn" onclick="closeUserActionsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="user-actions">
                <div class="user-info">
                    <img id="actionUserAvatar" src="" alt="">
                    <span id="actionUserName"></span>
                </div>
                <div class="actions-grid">
                    <button onclick="viewUserProfile()" class="action-btn">
                        <i class="fas fa-user"></i>
                        <span>عرض الملف الشخصي</span>
                    </button>
                    <button onclick="startPrivateChat()" class="action-btn">
                        <i class="fas fa-envelope"></i>
                        <span>رسالة خاصة</span>
                    </button>
                    <button onclick="openBanUserModal()" class="action-btn ban-btn">
                        <i class="fas fa-ban"></i>
                        <span>حظر</span>
                    </button>
                    <button onclick="openMuteUserModal()" class="action-btn mute-btn">
                        <i class="fas fa-volume-mute"></i>
                        <span>كتم</span>
                    </button>
                    <button onclick="openAssignRankModal()" class="action-btn rank-btn">
                        <i class="fas fa-crown"></i>
                        <span>تعيين رتبة</span>
                    </button>
                    <button onclick="openGiveCoinsModal()" class="action-btn coins-btn">
                        <i class="fas fa-coins"></i>
                        <span>إعطاء نقاط</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال حظر المستخدم -->
    <div id="banUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>حظر المستخدم</h2>
                <button class="close-btn" onclick="closeModal('banUserModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="ban-form">
                <div class="form-group">
                    <label>المستخدم المحدد:</label>
                    <span id="banTargetUser" data-user-id=""></span>
                </div>
                <div class="form-group">
                    <label>سبب الحظر:</label>
                    <textarea id="banReason" placeholder="اكتب سبب الحظر..." required></textarea>
                </div>
                <div class="form-group">
                    <label>مدة الحظر:</label>
                    <select id="banDuration">
                        <option value="1">ساعة واحدة</option>
                        <option value="24">24 ساعة</option>
                        <option value="168">أسبوع واحد</option>
                        <option value="720">شهر واحد</option>
                        <option value="permanent">دائم</option>
                    </select>
                </div>
                <button onclick="banUser()" class="btn btn-danger">
                    <i class="fas fa-ban"></i>
                    حظر المستخدم
                </button>
            </div>
        </div>
    </div>

    <!-- مودال كتم المستخدم (جديد حسب المواصفات) -->
    <div id="muteUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>كتم المستخدم</h2>
                <button class="close-btn" onclick="closeModal('muteUserModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mute-form">
                <div class="form-group">
                    <label>المستخدم المحدد:</label>
                    <span id="muteTargetUser" data-user-id=""></span>
                </div>
                <div class="form-group">
                    <label>سبب الكتم:</label>
                    <textarea id="muteReason" placeholder="اكتب سبب الكتم..." required></textarea>
                </div>
                <div class="form-group">
                    <label>مدة الكتم:</label>
                    <select id="muteDuration">
                        <option value="5">5 دقائق</option>
                        <option value="10">10 دقائق</option>
                        <option value="30">30 دقيقة</option>
                        <option value="60">ساعة واحدة</option>
                        <option value="permanent">دائم</option>
                    </select>
                </div>
                <button onclick="muteUser()" class="btn btn-warning">
                    <i class="fas fa-volume-mute"></i>
                    كتم المستخدم
                </button>
            </div>
        </div>
    </div>

    <!-- مودال تعيين الرتبة -->
    <div id="assignRankModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تعيين رتبة</h2>
                <button class="close-btn" onclick="closeAssignRankModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="rank-form">
                <div class="form-group">
                    <label>المستخدم:</label>
                    <span id="rankTargetUser"></span>
                </div>
                <div class="form-group">
                    <label>الرتبة الجديدة:</label>
                    <select id="newRankSelect">
                        <option value="visitor">زائر</option>
                        <option value="bronze">عضو برونزي</option>
                        <option value="silver">عضو فضي</option>
                        <option value="gold">عضو ذهبي</option>
                        <option value="trophy">كأس</option>
                        <option value="diamond">عضو الماس</option>
                        <option value="prince">برنس</option>
                        <option value="moderator">مشرف</option>
                        <option value="admin">إداري</option>
                        <option value="owner">مالك</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>سبب التغيير:</label>
                    <textarea id="rankChangeReason" placeholder="سبب تغيير الرتبة (اختياري)"></textarea>
                </div>
                <button onclick="confirmAssignRank()" class="btn btn-primary">
                    <i class="fas fa-crown"></i>
                    تعيين الرتبة
                </button>
            </div>
        </div>
    </div>

    <!-- مودال إنشاء رتبة جديدة (جديد حسب المواصفات) -->
    <div id="createRankModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>إنشاء رتبة جديدة</h2>
                <button class="close-btn" onclick="closeModal('createRankModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="create-rank-form">
                <div class="form-group">
                    <label>اسم الرتبة:</label>
                    <input type="text" id="rankName" placeholder="مثال: عضو VIP" required>
                </div>
                <div class="form-group">
                    <label>وصف الرتبة:</label>
                    <textarea id="rankDescription" placeholder="ما هي صلاحيات ومميزات هذه الرتبة؟"></textarea>
                </div>
                <div class="form-group">
                    <label>لون الرتبة:</label>
                    <input type="color" id="rankColor" value="#ffffff">
                </div>
                <div class="permissions-section">
                    <h4>الصلاحيات:</h4>
                    <div class="permission-item">
                        <input type="checkbox" id="perm_create_room">
                        <label for="perm_create_room">إنشاء غرف</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm_delete_room">
                        <label for="perm_delete_room">حذف غرف</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm_ban_user">
                        <label for="perm_ban_user">حظر مستخدمين</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm_mute_user">
                        <label for="perm_mute_user">كتم مستخدمين</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm_assign_rank">
                        <label for="perm_assign_rank">تعيين رتب</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm_send_global_notification">
                        <label for="perm_send_global_notification">إرسال إشعارات عامة</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm_upload_music">
                        <label for="perm_upload_music">رفع موسيقى</label>
                    </div>
                    <div class="permission-item">
                        <input type="checkbox" id="perm_play_music">
                        <label for="perm_play_music">تشغيل موسيقى في الغرف</label>
                    </div>
                </div>
                <button onclick="createRank()" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    إنشاء الرتبة
                </button>
            </div>
        </div>
    </div>

    <!-- مودال الإشعارات -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>الإشعارات</h2>
                <button class="close-btn" onclick="closeNotificationsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="notificationsList" class="notifications-list">
                <!-- سيتم ملؤها بالجافاسكريبت -->
                <!--
                <div class="notification-item">
                    <div class="notification-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">رسالة خاصة من <strong>أحمد</strong></div>
                        <div class="notification-message">مرحباً، كيف حالك؟</div>
                        <div class="notification-time">منذ 2 دقيقة</div>
                    </div>
                </div>
                -->
            </div>
        </div>
    </div>

    <!-- مودال الإعدادات -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>الإعدادات</h2>
                <button class="close-btn" onclick="closeSettingsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="settings-content">
                <div class="settings-section">
                    <h3>إعدادات الصوت</h3>
                    <div class="setting-item">
                        <label>أصوات الإشعارات</label>
                        <label class="switch">
                            <input type="checkbox" id="soundNotifications" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>إعدادات الدردشة</h3>
                    <div class="setting-item">
                        <label>حفظ تاريخ الدردشة</label>
                        <label class="switch">
                            <input type="checkbox" id="saveChatHistory" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>فلترة الكلمات غير اللائقة</label>
                        <label class="switch">
                            <input type="checkbox" id="filterBadWords" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>إجراءات</h3>
                    <button onclick="exitChat()" class="btn btn-warning">
                        <i class="fas fa-sign-out-alt"></i>
                        الخروج من الدردشة
                    </button>
                    <button onclick="exitRoom()" class="btn btn-secondary">
                        <i class="fas fa-door-open"></i>
                        الخروج من الغرفة
                    </button>
                    <button onclick="openHelpModal()" class="btn btn-info">
                        <i class="fas fa-question-circle"></i>
                        المساعدة
                    </button>
                    <button onclick="showRanks()" class="btn btn-primary">
                        <i class="fas fa-crown"></i>
                        عرض الرتب
                    </button>
                    <button onclick="cleanRooms()" class="btn btn-danger">
                        <i class="fas fa-broom"></i>
                        تنظيف الغرف
                    </button>
                </div>
                <button onclick="saveSettings()" class="btn save-btn">
                    <i class="fas fa-save"></i>
                    حفظ الإعدادات
                </button>
            </div>
        </div>
    </div>

    <!-- مودال مشغل الراديو -->
    <div id="radioPlayerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📻 مشغل الراديو</h2>
                <button class="close-btn" onclick="closeRadioPlayer()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="radio-content">
                <div class="radio-stations">
                    <div class="station" onclick="playRadioStation('arabic')">
                        <i class="fas fa-music"></i>
                        <span>محطة الأغاني العربية</span>
                    </div>
                    <div class="station" onclick="playRadioStation('english')">
                        <i class="fas fa-music"></i>
                        <span>محطة الأغاني الأجنبية</span>
                    </div>
                    <div class="station" onclick="playRadioStation('classical')">
                        <i class="fas fa-music"></i>
                        <span>محطة الموسيقى الكلاسيكية</span>
                    </div>
                </div>
                <div class="radio-controls">
                    <button id="radioPlayBtn" onclick="toggleRadio()">
                        <i class="fas fa-play"></i>
                    </button>
                    <input type="range" id="radioVolume" min="0" max="100" value="50">
                </div>
                <div class="custom-music">
                    <h4>أغانيك الخاصة</h4>
                    <input type="file" id="customMusicInput" accept="audio/*" multiple>
                    <button onclick="uploadCustomMusic()" class="btn">
                        <i class="fas fa-upload"></i>
                        رفع أغاني
                    </button>
                    <div id="customMusicList" class="custom-music-list">
                        <!-- سيتم ملؤها بالجافاسكريبت -->
                    </div>
                </div>
                <!-- قسم البحث عن الأغاني (جديد حسب المواصفات) -->
                <div class="music-search-section">
                    <h4>🔍 البحث عن أغنية</h4>
                    <div class="search-box">
                        <input type="text" id="musicSearchInput" placeholder="ابحث عن أغنية...">
                        <button onclick="searchMusic()" class="btn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="searchResults" class="search-results">
                        <!-- سيتم ملؤها بالجافاسكريبت -->
                        <!--
                        <div class="search-result-item" onclick="playSearchedSong('رابط الأغنية', 'اسم الأغنية')">
                            <img src="song-cover.jpg" class="result-cover">
                            <div class="result-info">
                                <div class="result-title">اسم الأغنية</div>
                                <div class="result-artist">اسم الفنان</div>
                            </div>
                        </div>
                        -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال إنشاء غرفة -->
    <div id="createRoomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>إنشاء غرفة جديدة</h2>
                <button class="close-btn" onclick="closeCreateRoomModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="room-form">
                <div class="form-group">
                    <label>اسم الغرفة:</label>
                    <input type="text" id="roomName" placeholder="اسم الغرفة" required>
                </div>
                <div class="form-group">
                    <label>وصف الغرفة:</label>
                    <textarea id="roomDescription" placeholder="وصف الغرفة (اختياري)"></textarea>
                </div>
                <div class="form-group">
                    <label>نوع الغرفة:</label>
                    <select id="roomType">
                        <option value="public">عام</option>
                        <option value="private">خاص</option>
                        <option value="quiz">مسابقة</option>
                        <option value="music">موسيقى</option>
                        <option value="game">ألعاب</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>خلفية الغرفة:</label>
                    <input type="file" id="roomBackgroundInput" accept="image/*">
                </div>
                <div class="form-group">
                    <label>صلاحيات الدخول:</label>
                    <select id="roomAccessRank">
                        <option value="visitor">الجميع</option>
                        <option value="bronze">برونزي فما فوق</option>
                        <option value="silver">فضي فما فوق</option>
                        <option value="gold">ذهبي فما فوق</option>
                        <option value="diamond">الماس فما فوق</option>
                        <option value="moderator">المشرفون فما فوق</option>
                    </select>
                </div>
                <button onclick="createRoom()" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    إنشاء الغرفة
                </button>
            </div>
        </div>
    </div>

    <!-- مودال إهداء النقاط -->
    <div id="giveCoinsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>إهداء نقاط</h2>
                <button class="close-btn" onclick="closeModal('giveCoinsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="coins-form">
                <div class="form-group">
                    <label>المستخدم المحدد:</label>
                    <span id="coinsTargetUser" data-user-id=""></span>
                </div>
                <div class="form-group">
                    <label>عدد النقاط:</label>
                    <input type="number" id="coinsAmount" placeholder="عدد النقاط" min="1" max="10000" required>
                </div>
                <div class="form-group">
                    <label>سبب الإهداء:</label>
                    <textarea id="coinsReason" placeholder="سبب إهداء النقاط (اختياري)"></textarea>
                </div>
                <button onclick="giveCoins()" class="btn btn-primary">
                    <i class="fas fa-coins"></i>
                    إهداء النقاط
                </button>
            </div>
        </div>
    </div>

    <!-- مودال إرسال إشعار (تم توحيد النسختين) -->
    <div id="sendNotificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔔 إرسال إشعار</h2>
                <button class="close-btn" onclick="closeSendNotificationModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="notification-form">
                    <div class="form-group">
                        <label for="notificationRecipient">اختر المستخدم:</label>
                        <select id="notificationRecipient" class="form-control">
                            <option value="">اختر مستخدم...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="notificationType">نوع الإشعار:</label>
                        <select id="notificationType" class="form-control">
                            <option value="info">معلومات</option>
                            <option value="success">نجاح</option>
                            <option value="warning">تحذير</option>
                            <option value="error">خطأ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="notificationMessage">رسالة الإشعار:</label>
                        <textarea id="notificationMessage" class="form-control" placeholder="اكتب رسالة الإشعار هنا..." rows="4"></textarea>
                    </div>
                    <div class="modal-actions">
                        <button onclick="sendNotificationToUser()" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                            إرسال الإشعار
                        </button>
                        <button onclick="closeSendNotificationModal()" class="btn btn-secondary">
                            إلغاء
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال المتصلين حالياً -->
    <div id="onlineUsersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>👥 المتصلين حالياً</h2>
                <button class="close-btn" onclick="closeOnlineUsersModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="onlineUsersList" class="online-users-list">
                    <p style="text-align: center; color: var(--text-secondary); padding: 20px;">
                        جاري تحميل قائمة المتصلين...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- صندوق الدردشة الخاصة -->
    <div id="privateChatBox" class="private-chat-box" style="display: none;">
        <div class="chat-box-header">
            <h3 class="chat-box-title">💬 دردشة خاصة</h3>
            <div class="chat-box-controls">
                <button class="chat-box-btn" onclick="minimizePrivateChatBox()" title="تصغير">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="chat-box-btn" onclick="closePrivateChatBox()" title="إغلاق">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="chat-box-body">
            <div class="private-chat-users">
                <select id="privateChatUserSelect" onchange="selectPrivateChatUser()">
                    <option value="">اختر مستخدم للدردشة...</option>
                </select>
            </div>
            <div id="privateChatMessages" class="private-chat-messages">
                <p style="text-align: center; color: var(--text-secondary); padding: 20px;">
                    اختر مستخدم لبدء المحادثة
                </p>
            </div>
            <div class="private-chat-input">
                <input type="text" id="privateChatInput" placeholder="اكتب رسالة..." onkeypress="if(event.key==='Enter') sendPrivateChatMessage()">
                <button class="private-chat-send" onclick="sendPrivateChatMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner" style="display: none;">
        <div class="spinner"></div>
        <p>جاري التحميل...</p>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Audio Elements -->
    <audio id="notificationSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBjiR1/LNeSsFJHfH8N2QQAoUXrTp6......" type="audio/wav">
    </audio>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- ==================== JavaScript كامل ومعدل ==================== -->
    <script>
        // متغيرات عامة
        let socket;
        let currentUser = null;
        let currentRoom = 1;
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        let chatMode = 'public'; // public or private
        let selectedUserId = null;
        let quotedMessage = null;

        // الرتب المتاحة مع إضافة مالك (owner)
        const RANKS = {
            visitor: { name: 'زائر', emoji: '👋', level: 0, color: '#888', permissions: [] },
            bronze: { name: 'عضو برونزي', emoji: '🥉', level: 1, color: '#cd7f32', permissions: [] },
            silver: { name: 'عضو فضي', emoji: '🥈', level: 2, color: '#c0c0c0', permissions: [] },
            gold: { name: 'عضو ذهبي', emoji: '🥇', level: 3, color: '#ffd700', permissions: ['play_music'] },
            trophy: { name: 'كأس', emoji: '🏆', level: 4, color: '#ff6b35', permissions: ['play_music'] },
            diamond: { name: 'عضو الماس', emoji: '💎', level: 5, color: '#b9f2ff', permissions: ['play_music', 'upload_music'] },
            prince: { name: 'برنس', emoji: '👑', level: 6, color: 'linear-gradient(45deg, #ffd700, #ff6b35)', permissions: ['play_music', 'upload_music'] },
            moderator: { name: 'مشرف', emoji: '🛡️', level: 7, color: 'linear-gradient(45deg, #ff6b35, #f093fb)', permissions: ['play_music', 'upload_music', 'ban_user', 'mute_user', 'assign_rank'] },
            admin: { name: 'إداري', emoji: '⚡', level: 8, color: 'linear-gradient(45deg, #000000, #333333)', permissions: ['play_music', 'upload_music', 'ban_user', 'mute_user', 'assign_rank', 'create_room', 'delete_room', 'send_global_notification'] },
            owner: { name: 'مالك', emoji: '👑', level: 9, color: 'gold', permissions: ['all'] } // صلاحيات كاملة
        };

        // أسئلة المسابقات
        const QUIZ_QUESTIONS = [
            {
                question: "ما هي عاصمة فرنسا؟",
                options: ["لندن", "برلين", "باريس", "روما"],
                correct: 2,
                hint: "مدينة الأنوار"
            },
            {
                question: "كم عدد قارات العالم؟",
                options: ["5", "6", "7", "8"],
                correct: 2,
                hint: "تشمل القارة القطبية الجنوبية"
            },
            {
                question: "ما هو أكبر محيط في العالم؟",
                options: ["الأطلسي", "الهندي", "المتجمد الشمالي", "الهادئ"],
                correct: 3,
                hint: "يغطي ثلث سطح الأرض"
            },
            {
                question: "في أي عام تم اختراع الإنترنت؟",
                options: ["1969", "1975", "1983", "1991"],
                correct: 0,
                hint: "في أواخر الستينات"
            },
            {
                question: "ما هو أطول نهر في العالم؟",
                options: ["النيل", "الأمازون", "اليانغتسي", "المسيسيبي"],
                correct: 0,
                hint: "يجري في قارة إفريقيا"
            }
        ];

        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            checkAuthStatus();
        });

        // تهيئة التطبيق
        function initializeApp() {
            // إخفاء جميع الشاشات
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            // عرض شاشة تسجيل الدخول
            document.getElementById('loginScreen').classList.add('active');
            // تهيئة الأصوات
            initializeAudio();
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // تسجيل الدخول
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('guestForm').addEventListener('submit', handleGuestLogin);
            // إرسال الرسائل
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            // رفع الصور
            document.getElementById('imageInput').addEventListener('change', handleImageUpload);
            // تغيير الغرفة
            document.getElementById('roomSelect').addEventListener('change', changeRoom);
            // إغلاق المودالات عند النقر خارجها
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeAllModals();
                }
            });
        }

        // التحقق من حالة المصادقة
        function checkAuthStatus() {
            const token = localStorage.getItem('chatToken');
            if (token) {
                // التحقق من صحة التوكن
                fetch('/api/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Invalid token');
                })
                .then(user => {
                    currentUser = user;
                    showMainScreen();
                    initializeSocket();
                })
                .catch(() => {
                    localStorage.removeItem('chatToken');
                    showLoginScreen();
                });
            } else {
                showLoginScreen();
            }
        }

        // عرض شاشة تسجيل الدخول
        function showLoginScreen() {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById('loginScreen').classList.add('active');
        }

        // عرض الشاشة الرئيسية
        function showMainScreen() {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById('mainScreen').classList.add('active');
            // تحديث معلومات المستخدم في الواجهة
            updateUserInterface();
            // تحميل الغرف
            loadRooms();
            // تحميل الرسائل
            loadMessages();
        }

        // تحديث واجهة المستخدم
        function updateUserInterface() {
            if (!currentUser) return;
            // تحديث معلومات المستخدم في الشريط العلوي
            document.getElementById('headerUserName').textContent = currentUser.display_name || currentUser.email;
            document.getElementById('headerUserRank').textContent = RANKS[currentUser.rank]?.name || 'زائر';
            // تحديث صورة المستخدم
            const avatarImg = document.getElementById('headerUserAvatar');
            if (currentUser.profile_image1) {
                avatarImg.src = currentUser.profile_image1;
            }
            // إظهار أزرار الإدارة حسب الدور
            const adminBtn = document.getElementById('adminPanelBtn');
            const roomsBtn = document.getElementById('roomsManagerBtn');
            const clearBtn = document.getElementById('clearChatBtn');
            
            // التحقق من الصلاحيات — فقط المالك والمشرفون
            if (hasPermission('create_room') || hasPermission('delete_room') || currentUser.role === 'owner') {
                if (adminBtn) adminBtn.style.display = 'block';
                if (roomsBtn) roomsBtn.style.display = 'block';
                if (clearBtn) clearBtn.style.display = 'block';
            }
            
            // تعيين دور المستخدم في الجسم
            document.body.setAttribute('data-user-role', currentUser.role);
            document.body.setAttribute('data-user-rank', currentUser.rank);
        }

        // التحقق من الصلاحية
        function hasPermission(permission) {
            if (!currentUser) return false;
            const userRank = RANKS[currentUser.rank];
            if (!userRank) return false;
            if (userRank.permissions.includes('all')) return true;
            return userRank.permissions.includes(permission);
        }

        // تهيئة Socket.IO
        function initializeSocket() {
            const token = localStorage.getItem('chatToken');
            socket = io({
                auth: {
                    token: token
                }
            });

            // الاتصال
            socket.on('connect', () => {
                console.log('متصل بالخادم');
                socket.emit('join', {
                    userId: currentUser.id,
                    displayName: currentUser.display_name,
                    rank: currentUser.rank,
                    email: currentUser.email,
                    roomId: currentRoom,
                    token: token
                });
            });

            // رسالة جديدة
            socket.on('newMessage', (message) => {
                // فلترة الكلمات غير اللائقة
                if (isInappropriate(message.message)) {
                    if (hasPermission('ban_user')) {
                        showNotification(`تم حذف رسالة غير لائقة من ${message.display_name}`, 'warning');
                    }
                    return; // لا تظهر الرسالة
                }
                displayMessage(message);
                playNotificationSound();
            });

            // رسالة خاصة جديدة
            socket.on('newPrivateMessage', (message) => {
                if (chatMode === 'private' && 
                    (message.user_id === selectedUserId || message.receiver_id === currentUser.id)) {
                    displayPrivateMessage(message);
                }
                playNotificationSound();
                updateNotificationCount();
                // إظهار إشعار تلقائي عند استلام رسالة خاصة
                showPrivateMessageNotification(message);
            });

            // تحديث قائمة المستخدمين
            socket.on('roomUsersList', (users) => {
                updateUsersList(users);
            });

            // حذف رسالة
            socket.on('messageDeleted', (messageId) => {
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.remove();
                }
            });

            // إشعار جديد
            socket.on('newNotification', (notification) => {
                showNotification(notification.message, notification.type || 'info');
                updateNotificationCount();
                notificationsList.push(notification);
            });

            // تحديث قائمة المتصلين
            socket.on('onlineUsersUpdated', (users) => {
                onlineUsersList = users;
                // تحديث العدد في الشريط الجانبي
                const sidebarCount = document.getElementById('onlineCount');
                if (sidebarCount) {
                    sidebarCount.textContent = users.length;
                }
                // تحديث قائمة المتصلين في المودال إذا كان مفتوحاً
                const modal = document.getElementById('onlineUsersModal');
                if (modal && modal.classList.contains('modal') && modal.style.display !== 'none') {
                    displayOnlineUsers();
                }
            });

            // قطع الاتصال
            socket.on('disconnect', () => {
                console.log('انقطع الاتصال بالخادم');
                showNotification('انقطع الاتصال بالخادم', 'error');
            });

            // معالجة أخطاء الأمان
            socket.on('error', (errorMessage) => {
                console.error('خطأ في الأمان:', errorMessage);
                showNotification('خطأ في الأمان: ' + errorMessage, 'error');
                // إعادة توجيه لصفحة تسجيل الدخول
                localStorage.removeItem('chatToken');
                showLoginScreen();
            });
        }

        // فلترة الكلمات غير اللائقة
        function isInappropriate(text) {
            const badWords = ['كلمة1', 'كلمة2', 'كلمة3']; // يمكنك تعديلها
            if (!text) return false;
            return badWords.some(word => text.toLowerCase().includes(word.toLowerCase()));
        }

        // تسجيل الدخول
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                showError('يرجى ملء جميع الحقول');
                return;
            }
            try {
                showLoading(true);
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('chatToken', data.token);
                    currentUser = data.user;
                    showMainScreen();
                    initializeSocket();
                    showNotification('تم تسجيل الدخول بنجاح', 'success');
                } else {
                    if (data.error.includes('محظور')) {
                        showBanScreen(data.banReason || 'لم يتم تحديد سبب الحظر');
                    } else {
                        showError(data.error);
                    }
                }
            } catch (error) {
                showError('حدث خطأ في الاتصال');
            } finally {
                showLoading(false);
            }
        }

        // إنشاء حساب جديد
        async function handleRegister(e) {
            e.preventDefault();
            const displayName = document.getElementById('registerDisplayName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            if (!email || !password) {
                showError('يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            if (password.length < 6) {
                showError('كلمة المرور يجب أن تكون 6 أحرف على الأقل');
                return;
            }
            try {
                showLoading(true);
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password, display_name: displayName })
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('chatToken', data.token);
                    currentUser = data.user;
                    showMainScreen();
                    initializeSocket();
                    showNotification('تم إنشاء الحساب بنجاح', 'success');
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('حدث خطأ في الاتصال');
            } finally {
                showLoading(false);
            }
        }

        // دخول كزائر
        async function handleGuestLogin(e) {
            e.preventDefault();
            const name = document.getElementById('guestName').value;
            const age = document.getElementById('guestAge').value;
            const gender = document.getElementById('guestGender').value;
            if (!name || !age || !gender) {
                showError('يرجى ملء جميع الحقول');
                return;
            }
            if (age < 13 || age > 99) {
                showError('العمر يجب أن يكون بين 13 و 99 سنة');
                return;
            }
            // إنشاء مستخدم زائر مؤقت
            currentUser = {
                id: Date.now(),
                display_name: name,
                email: `guest_${Date.now()}@temp.com`,
                role: 'user',
                rank: 'visitor',
                age: parseInt(age),
                gender: gender,
                isGuest: true
            };
            showMainScreen();
            initializeSocket();
            showNotification('مرحباً بك كزائر', 'success');
        }

        // تسجيل الدخول عبر Google
        function loginWithGoogle() {
            showNotification('جارٍ التسجيل عبر Google...', 'info');
            // محاكاة تسجيل الدخول
            setTimeout(() => {
                currentUser = {
                    id: Date.now(),
                    display_name: 'مستخدم جوجل',
                    email: `google_${Date.now()}@gmail.com`,
                    role: 'user',
                    rank: 'silver',
                    isSocialLogin: true,
                    provider: 'google'
                };
                showMainScreen();
                initializeSocket();
                showNotification('تم تسجيل الدخول عبر Google بنجاح', 'success');
            }, 1500);
        }

        // تسجيل الدخول عبر Facebook
        function loginWithFacebook() {
            showNotification('جارٍ التسجيل عبر Facebook...', 'info');
            // محاكاة تسجيل الدخول
            setTimeout(() => {
                currentUser = {
                    id: Date.now(),
                    display_name: 'مستخدم فيسبوك',
                    email: `facebook_${Date.now()}@facebook.com`,
                    role: 'user',
                    rank: 'bronze',
                    isSocialLogin: true,
                    provider: 'facebook'
                };
                showMainScreen();
                initializeSocket();
                showNotification('تم تسجيل الدخول عبر Facebook بنجاح', 'success');
            }, 1500);
        }

        // عرض شاشة الحظر
        function showBanScreen(reason) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById('banScreen').classList.add('active');
            document.getElementById('banReason').innerHTML = `<p>${reason}</p>`;
        }

        // التحقق من حالة الحظر
        async function checkBanStatus() {
            const token = localStorage.getItem('chatToken');
            if (!token) {
                showLoginScreen();
                return;
            }
            try {
                const response = await fetch('/api/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) {
                    const user = await response.json();
                    currentUser = user;
                    showMainScreen();
                    initializeSocket();
                    showNotification('تم رفع الحظر', 'success');
                } else {
                    showNotification('لا يزال الحظر ساري المفعول', 'error');
                }
            } catch (error) {
                showError('حدث خطأ في التحقق من حالة الحظر');
            }
        }

        // تحميل الغرف
        async function loadRooms() {
            try {
                const token = localStorage.getItem('chatToken');
                const response = await fetch('/api/rooms', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) {
                    const rooms = await response.json();
                    updateRoomsSelect(rooms);
                }
            } catch (error) {
                console.error('خطأ في تحميل الغرف:', error);
            }
        }

        // تحديث قائمة الغرف
        function updateRoomsSelect(rooms) {
            const select = document.getElementById('roomSelect');
            select.innerHTML = '';
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.id;
                option.textContent = room.name;
                if (room.id === currentRoom) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // تغيير الغرفة
        function changeRoom() {
            const newRoomId = parseInt(document.getElementById('roomSelect').value);
            if (newRoomId !== currentRoom) {
                currentRoom = newRoomId;
                // إشعار الخادم بتغيير الغرفة
                if (socket) {
                    socket.emit('changeRoom', newRoomId);
                }
                // تحديث اسم الغرفة
                const roomName = document.getElementById('roomSelect').selectedOptions[0].textContent;
                document.getElementById('currentRoomName').textContent = roomName;
                // مسح الرسائل وتحميل رسائل الغرفة الجديدة
                document.getElementById('messagesContainer').innerHTML = '';
                loadMessages();
            }
        }

        // تحميل الرسائل
        async function loadMessages() {
            try {
                const token = localStorage.getItem('chatToken');
                if (!token && !currentUser?.isGuest) return;
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                const response = await fetch(`/api/messages/${currentRoom}`, { headers });
                if (response.ok) {
                    const messages = await response.json();
                    const container = document.getElementById('messagesContainer');
                    container.innerHTML = '';
                    messages.forEach(message => {
                        displayMessage(message);
                    });
                    scrollToBottom();
                }
            } catch (error) {
                console.error('خطأ في تحميل الرسائل:', error);
            }
        }

        // عرض رسالة
        function displayMessage(message) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.user_id === currentUser?.id ? 'own' : ''}`;
            messageDiv.setAttribute('data-message-id', message.id);
            
            // إضافة خيارات الرسالة (ثلاث نقاط)
            const optionsBtn = document.createElement('button');
            optionsBtn.className = 'message-options-btn';
            optionsBtn.innerHTML = '<i class="fas fa-ellipsis-v"></i>';
            optionsBtn.onclick = (e) => {
                e.stopPropagation();
                showMessageOptions(message, messageDiv);
            };
            
            const rank = RANKS[message.rank] || RANKS.visitor;
            const time = new Date(message.timestamp).toLocaleTimeString('ar-SA', {
                hour: '2-digit',
                minute: '2-digit'
            });
            let messageContent = '';
            // محتوى الرسالة
            if (message.message) {
                messageContent = `<div class="message-text">${escapeHtml(message.message)}</div>`;
            } else if (message.voice_url) {
                messageContent = `<audio class="message-audio" controls>
                    <source src="${message.voice_url}" type="audio/webm">
                    متصفحك لا يدعم تشغيل الصوت
                </audio>`;
            } else if (message.image_url) {
                messageContent = `<img class="message-image" src="${message.image_url}" alt="صورة" onclick="openImageModal('${message.image_url}')">`;
            }
            messageDiv.innerHTML = `
                <img class="message-avatar" src="${message.profile_image1 || 'https://images.pexels.com/photos/771742/pexels-photo-771742.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop'}" 
                     alt="صورة ${message.display_name}" onclick="openUserProfile(${message.user_id})">
                <div class="message-content" style="${message.message_background ? `background-image: url(${message.message_background})` : ''}">
                    <div class="message-header">
                        <span class="message-author rank-${message.rank}" onclick="openUserProfile(${message.user_id})">${escapeHtml(message.display_name)}</span>
                        <span class="message-rank">${rank.emoji} ${rank.name}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    ${messageContent}
                </div>
            `;
            messageDiv.appendChild(optionsBtn);
            container.appendChild(messageDiv);
            scrollToBottom();
        }

        // عرض خيارات الرسالة
        function showMessageOptions(message, messageElement) {
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'message-options';
            optionsDiv.innerHTML = `
                <button onclick="quoteMessage(${message.id}, '${escapeHtml(message.display_name)}', '${escapeHtml(message.message)}')">
                    <i class="fas fa-quote-right"></i> اقتباس
                </button>
                <button onclick="reportMessage(${message.id})">
                    <i class="fas fa-flag"></i> بلاغ
                </button>
                <button onclick="notifyAboutMessage(${message.id}, '${escapeHtml(message.display_name)}')">
                    <i class="fas fa-bell"></i> إشعار
                </button>
                ${message.user_id === currentUser?.id || hasPermission('delete_message') ? `
                <button onclick="deleteMessage(${message.id}, this)">
                    <i class="fas fa-trash"></i> حذف
                </button>` : ''}
            `;
            // إضافة الخيارات بجانب الرسالة
            messageElement.appendChild(optionsDiv);
            // إغلاق الخيارات عند النقر خارجها
            document.addEventListener('click', function closeOptions(e) {
                if (!messageElement.contains(e.target) && !optionsDiv.contains(e.target)) {
                    optionsDiv.remove();
                    document.removeEventListener('click', closeOptions);
                }
            });
        }

        // إرسال رسالة
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            if (message.length > 1000) {
                showError('الرسالة طويلة جداً (الحد الأقصى 1000 حرف)');
                return;
            }
            if (socket) {
                const messageData = {
                    message: message,
                    roomId: currentRoom
                };
                // إضافة الاقتباس إذا كان موجوداً
                if (quotedMessage) {
                    messageData.quoted_message_id = quotedMessage.id;
                    messageData.quoted_author = quotedMessage.author;
                    messageData.quoted_content = quotedMessage.content;
                }
                socket.emit('sendMessage', messageData);
                input.value = '';
                cancelQuote();
            }
        }

        // رفع صورة
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                showError('يرجى اختيار صورة صحيحة');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                showError('حجم الصورة كبير جداً (الحد الأقصى 5 ميجابايت)');
                return;
            }
            const formData = new FormData();
            formData.append('image', file);
            showLoading(true);
            fetch('/api/upload-image', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.image_url && socket) {
                    socket.emit('sendMessage', {
                        image_url: data.image_url,
                        roomId: currentRoom
                    });
                } else {
                    showError('فشل في رفع الصورة');
                }
            })
            .catch(error => {
                showError('حدث خطأ في رفع الصورة');
            })
            .finally(() => {
                showLoading(false);
                e.target.value = '';
            });
        }

        // تسجيل صوتي
        function toggleVoiceRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        // بدء التسجيل
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    uploadVoiceMessage(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };
                mediaRecorder.start();
                isRecording = true;
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.classList.add('recording');
                voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
                showNotification('بدأ التسجيل...', 'info');
            } catch (error) {
                showError('لا يمكن الوصول للميكروفون');
            }
        }

        // إيقاف التسجيل
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                const voiceBtn = document.getElementById('voiceBtn');
                voiceBtn.classList.remove('recording');
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                showNotification('تم إيقاف التسجيل', 'success');
            }
        }

        // رفع رسالة صوتية
        function uploadVoiceMessage(audioBlob) {
            const formData = new FormData();
            formData.append('voice', audioBlob, 'voice.webm');
            showLoading(true);
            fetch('/api/upload-voice', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.voice_url && socket) {
                    socket.emit('sendMessage', {
                        voice_url: data.voice_url,
                        roomId: currentRoom
                    });
                } else {
                    showError('فشل في رفع التسجيل الصوتي');
                }
            })
            .catch(error => {
                showError('حدث خطأ في رفع التسجيل الصوتي');
            })
            .finally(() => {
                showLoading(false);
            });
        }

        // تحديث قائمة المستخدمين
        function updateUsersList(users) {
            const container = document.getElementById('onlineUsersList');
            const countElement = document.getElementById('onlineCount');
            container.innerHTML = '';
            countElement.textContent = users.length;
            // ترتيب المستخدمين حسب الرتبة
            users.sort((a, b) => {
                const rankA = RANKS[a.rank] || RANKS.visitor;
                const rankB = RANKS[b.rank] || RANKS.visitor;
                return rankB.level - rankA.level;
            });
            users.forEach(user => {
                if (user.userId === currentUser?.id) return; // لا نعرض المستخدم الحالي
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                userDiv.onclick = () => openUserActions(user);
                const rank = RANKS[user.rank] || RANKS.visitor;
                userDiv.innerHTML = `
                    <img class="user-avatar" src="https://images.pexels.com/photos/771742/pexels-photo-771742.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop" alt="${user.displayName}">
                    <div class="user-details">
                        <div class="user-display-name rank-${user.rank}">${escapeHtml(user.displayName)}</div>
                        <div class="user-status">${rank.emoji} ${rank.name}</div>
                    </div>
                `;
                container.appendChild(userDiv);
            });
        }

        // فتح إجراءات المستخدم
        function openUserActions(user) {
            selectedUserId = user.userId;
            document.getElementById('actionUserName').textContent = user.displayName;
            document.getElementById('actionUserAvatar').src = 'https://images.pexels.com/photos/771742/pexels-photo-771742.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop';
            openModal('userActionsModal');
        }

        // بدء دردشة خاصة
        function startPrivateChat() {
            if (!selectedUserId) return;
            chatMode = 'private';
            document.getElementById('chatModeText').textContent = 'خاص';
            // تحديث واجهة الدردشة الخاصة
            loadPrivateMessages();
            closeAllModals();
            showNotification('تم التبديل للدردشة الخاصة', 'info');
        }

        // تحميل الرسائل الخاصة
        async function loadPrivateMessages() {
            if (!selectedUserId) return;
            try {
                const token = localStorage.getItem('chatToken');
                const response = await fetch(`/api/private-messages/${selectedUserId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) {
                    const messages = await response.json();
                    const container = document.getElementById('messagesContainer');
                    container.innerHTML = '';
                    messages.forEach(message => {
                        displayPrivateMessage(message);
                    });
                    scrollToBottom();
                }
            } catch (error) {
                console.error('خطأ في تحميل الرسائل الخاصة:', error);
            }
        }

        // عرض رسالة خاصة
        function displayPrivateMessage(message) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.user_id === currentUser?.id ? 'own' : ''}`;
            messageDiv.setAttribute('data-message-id', message.id);
            const rank = RANKS[message.rank] || RANKS.visitor;
            const time = new Date(message.timestamp).toLocaleTimeString('ar-SA', {
                hour: '2-digit',
                minute: '2-digit'
            });
            let messageContent = '';
            if (message.message) {
                messageContent = `<div class="message-text">${escapeHtml(message.message)}</div>`;
            } else if (message.voice_url) {
                messageContent = `<audio class="message-audio" controls>
                    <source src="${message.voice_url}" type="audio/webm">
                </audio>`;
            } else if (message.image_url) {
                messageContent = `<img class="message-image" src="${message.image_url}" alt="صورة" onclick="openImageModal('${message.image_url}')">`;
            }
            messageDiv.innerHTML = `
                <img class="message-avatar" src="https://images.pexels.com/photos/771742/pexels-photo-771742.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop" alt="${message.display_name}">
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author rank-${message.rank}">${escapeHtml(message.display_name)}</span>
                        <span class="message-rank">${rank.emoji} ${rank.name}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    ${messageContent}
                </div>
            `;
            container.appendChild(messageDiv);
            scrollToBottom();
        }

        // تبديل وضع الدردشة
        function toggleChatMode() {
            if (chatMode === 'public') {
                // التبديل للخاص يتطلب اختيار مستخدم
                showNotification('اختر مستخدماً لبدء دردشة خاصة', 'info');
            } else {
                // العودة للعام
                chatMode = 'public';
                selectedUserId = null;
                document.getElementById('chatModeText').textContent = 'عام';
                loadMessages();
                showNotification('تم التبديل للدردشة العامة', 'info');
            }
        }

        // فتح القائمة الرئيسية
        function openMainMenu() {
            openModal('mainMenuModal');
        }

        // إغلاق القائمة الرئيسية
        function closeMainMenu() {
            closeModal('mainMenuModal');
        }

        // فتح قسم الأخبار
        function openNewsSection() {
            openModal('newsModal');
            loadNews();
            closeMainMenu();
        }

        // تحميل الأخبار
        async function loadNews() {
            try {
                const response = await fetch('/api/news');
                if (response.ok) {
                    const news = await response.json();
                    displayNews(news);
                }
            } catch (error) {
                console.error('خطأ في تحميل الأخبار:', error);
            }
        }

        // عرض الأخبار
        function displayNews(news) {
            const container = document.getElementById('newsFeed');
            container.innerHTML = '';
            if (news.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">لا توجد أخبار حالياً</p>';
                return;
            }
            news.forEach(item => {
                const newsDiv = document.createElement('div');
                newsDiv.className = 'news-item';
                const time = new Date(item.timestamp).toLocaleString('ar-SA');
                newsDiv.innerHTML = `
                    <div class="news-header-info">
                        <img class="news-author-avatar" src="https://images.pexels.com/photos/771742/pexels-photo-771742.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop" alt="${item.display_name}">
                        <div class="news-author-info">
                            <h4>${escapeHtml(item.display_name)}</h4>
                            <span class="news-time">${time}</span>
                        </div>
                    </div>
                    <div class="news-content">${escapeHtml(item.content)}</div>
                    ${item.media ? `<div class="news-media"><img src="${item.media}" alt="صورة الخبر"></div>` : ''}
                `;
                container.appendChild(newsDiv);
            });
        }

        // نشر خبر
        async function postNews() {
            const content = document.getElementById('newsContentInput').value.trim();
            const fileInput = document.getElementById('newsFileInput');
            if (!content && !fileInput.files[0]) {
                showError('يرجى كتابة محتوى أو اختيار ملف');
                return;
            }
            const formData = new FormData();
            if (content) formData.append('content', content);
            if (fileInput.files[0]) formData.append('newsFile', fileInput.files[0]);
            try {
                showLoading(true);
                const response = await fetch('/api/news', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                    },
                    body: formData
                });
                if (response.ok) {
                    document.getElementById('newsContentInput').value = '';
                    fileInput.value = '';
                    loadNews();
                    showNotification('تم نشر الخبر بنجاح', 'success');
                } else {
                    const data = await response.json();
                    showError(data.error || 'فشل في نشر الخبر');
                }
            } catch (error) {
                showError('حدث خطأ في نشر الخبر');
            } finally {
                showLoading(false);
            }
        }

        // إغلاق مودال الأخبار
        function closeNewsModal() {
            closeModal('newsModal');
        }

        // فتح قسم القصص
        function openStoriesSection() {
            openModal('storiesModal');
            loadStories();
            closeMainMenu();
        }

        // تحميل القصص
        async function loadStories() {
            try {
                const response = await fetch('/api/stories');
                if (response.ok) {
                    const stories = await response.json();
                    displayStories(stories);
                }
            } catch (error) {
                console.error('خطأ في تحميل القصص:', error);
            }
        }

        // عرض القصص
        function displayStories(stories) {
            const container = document.getElementById('storiesContainer');
            container.innerHTML = '';
            if (stories.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">لا توجد قصص حالياً</p>';
                return;
            }
            stories.forEach(story => {
                const storyDiv = document.createElement('div');
                storyDiv.className = 'story-item';
                storyDiv.onclick = () => viewStory(story);
                storyDiv.innerHTML = `<img src="${story.image}" alt="قصة ${story.display_name}">`;
                container.appendChild(storyDiv);
            });
        }

        // فتح مودال إضافة قصة
        function openAddStoryModal() {
            openModal('addStoryModal');
        }

        // إغلاق مودال إضافة قصة
        function closeAddStoryModal() {
            closeModal('addStoryModal');
        }

        // إضافة قصة
        async function addStory() {
            const fileInput = document.getElementById('storyMediaInput');
            const text = document.getElementById('storyTextInput').value.trim();
            if (!fileInput.files[0]) {
                showError('يرجى اختيار صورة أو فيديو');
                return;
            }
            const formData = new FormData();
            formData.append('storyImage', fileInput.files[0]);
            if (text) formData.append('text', text);
            try {
                showLoading(true);
                const response = await fetch('/api/stories', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                    },
                    body: formData
                });
                if (response.ok) {
                    closeAddStoryModal();
                    loadStories();
                    showNotification('تم إضافة القصة بنجاح', 'success');
                } else {
                    const data = await response.json();
                    showError(data.error || 'فشل في إضافة القصة');
                }
            } catch (error) {
                showError('حدث خطأ في إضافة القصة');
            } finally {
                showLoading(false);
            }
        }

        // إغلاق مودال القصص
        function closeStoriesModal() {
            closeModal('storiesModal');
        }

        // فتح قسم الألعاب
        function openGamesSection() {
            showNotification('الألعاب قيد التطوير', 'info');
            closeMainMenu();
        }

        // فتح غرفة المسابقات
        function openQuizRoom() {
            openModal('quizRoomModal');
            startQuiz();
            closeMainMenu();
        }

        // بدء المسابقة
        function startQuiz() {
            const randomQuestion = QUIZ_QUESTIONS[Math.floor(Math.random() * QUIZ_QUESTIONS.length)];
            displayQuizQuestion(randomQuestion);
            startQuizTimerWithHints(randomQuestion.correct);
        }

        // عرض سؤال المسابقة
        function displayQuizQuestion(question) {
            document.getElementById('questionText').textContent = question.question;
            const optionsContainer = document.getElementById('questionOptions');
            optionsContainer.innerHTML = '';
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                button.onclick = () => selectQuizAnswer(index, question.correct);
                optionsContainer.appendChild(button);
            });
        }

        // اختيار إجابة
        function selectQuizAnswer(selected, correct) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach((btn, index) => {
                btn.disabled = true;
                if (index === correct) {
                    btn.style.background = 'var(--success-color)';
                } else if (index === selected && selected !== correct) {
                    btn.style.background = 'var(--error-color)';
                }
            });
            
            if (selected === correct) {
                const pointsEarned = 10;
                showNotification('إجابة صحيحة! +10 نقاط', 'success');
                updateUserCoins(pointsEarned);
                updateUserQuizRank(pointsEarned); // تحديث الترتيب
            } else {
                showNotification('إجابة خاطئة', 'error');
            }
            
            // إيقاف المؤقت الحالي
            if (contestTimer) {
                clearInterval(contestTimer);
            }
            
            setTimeout(() => {
                startQuiz(); // سؤال جديد
            }, 3000);
        }

        // بدء مؤقت المسابقة مع التلميحات
        function startQuizTimerWithHints(correctAnswerIndex) {
            let timeLeft = 15; // 15 ثانية أولاً
            let hintShown = false;
            const timerElement = document.getElementById('quizTimer');
            const hintSection = document.getElementById('hintSection');
            const hintText = document.getElementById('hintText');
            const question = QUIZ_QUESTIONS.find(q => q.correct === correctAnswerIndex);
            
            // إخفاء التلميح في البداية
            hintSection.style.display = 'none';
            
            contestTimer = setInterval(() => {
                timeLeft--;
                timerElement.textContent = timeLeft;
                
                // عرض التلميح بعد 15 ثانية
                if (timeLeft <= 0 && !hintShown) {
                    hintShown = true;
                    timeLeft = 10; // إعادة العد إلى 10 ثواني إضافية
                    hintSection.style.display = 'block';
                    hintSection.style.animation = 'fadeIn 0.5s ease';
                    hintText.textContent = `تلميح: ${question.hint}`;
                    timerElement.textContent = timeLeft;
                }
                
                // انتهاء الوقت
                if (timeLeft <= 0) {
                    clearInterval(contestTimer);
                    if (!hintShown) {
                        // لم يجاوب أحد خلال الـ 15 ثانية الأولى
                        hintShown = true;
                        hintSection.style.display = 'block';
                        hintSection.style.animation = 'fadeIn 0.5s ease';
                        hintText.textContent = `تلميح: ${question.hint}`;
                        setTimeout(() => {
                            revealAnswerAndNext(correctAnswerIndex);
                        }, 2000);
                    } else {
                        // لم يجاوب أحد حتى بعد التلميح
                        revealAnswerAndNext(correctAnswerIndex);
                    }
                }
            }, 1000);
        }

        // عرض الإجابة والانتقال للسؤال التالي
        function revealAnswerAndNext(correctAnswerIndex) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach((btn, index) => {
                btn.disabled = true;
                if (index === correctAnswerIndex) {
                    btn.style.background = 'var(--success-color)';
                }
            });
            showNotification(`الإجابة الصحيحة: ${QUIZ_QUESTIONS.find(q => q.options[correctAnswerIndex])?.options[correctAnswerIndex]}`, 'info');
            setTimeout(() => {
                startQuiz(); // سؤال جديد
            }, 3000);
        }

        // تحديث ترتيب المستخدم في المسابقة
        function updateUserQuizRank(points) {
            // محاكاة تحديث الترتيب
            let currentPoints = parseInt(document.getElementById('userQuizPoints').textContent) || 0;
            currentPoints += points;
            document.getElementById('userQuizPoints').textContent = currentPoints;
            // تحديث الترتيب (محاكاة)
            document.getElementById('userQuizRank').textContent = `#${Math.floor(Math.random() * 10) + 1}`;
            // تحديث لوحة المتصدرين
            updateLeaderboard(currentPoints);
        }

        // تحديث لوحة المتصدرين
        function updateLeaderboard(userPoints) {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = ''; // مسح القائمة الحالية

            // إنشاء قائمة وهمية
            const mockLeaders = [
                { name: currentUser?.display_name || 'أنت', score: userPoints },
                { name: 'أحمد', score: userPoints + 5 },
                { name: 'سارة', score: userPoints + 3 },
                { name: 'محمد', score: userPoints - 2 },
                { name: 'ليلى', score: userPoints - 5 }
            ];

            // ترتيب حسب النقاط
            mockLeaders.sort((a, b) => b.score - a.score);

            mockLeaders.forEach((leader, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <span class="rank">${index + 1}.</span>
                    <span class="username">${leader.name}</span>
                    <span class="score">${leader.score}</span>
                `;
                if (leader.name === (currentUser?.display_name || 'أنت')) {
                    item.style.color = 'gold';
                    item.style.fontWeight = 'bold';
                }
                leaderboardList.appendChild(item);
            });
        }

        // إغلاق غرفة المسابقات
        function closeQuizRoom() {
            if (contestTimer) {
                clearInterval(contestTimer);
            }
            closeModal('quizRoomModal');
        }

        // فتح إدارة الغرف
        function openRoomsManager() {
            if (!hasPermission('create_room')) {
                showError('غير مسموح - للإداريين فقط');
                return;
            }
            openModal('adminModal');
            showAdminTab('rooms');
            closeMainMenu();
        }

        // فتح متجر النقاط
        function openCoinsShop() {
            showNotification('متجر النقاط قيد التطوير', 'info');
            closeMainMenu();
        }

        // فتح لوحة الإدارة
        function openAdminPanel() {
            if (!hasPermission('create_room') && currentUser?.role !== 'owner') {
                showError('غير مسموح - للإداريين فقط');
                return;
            }
            openModal('adminModal');
            loadAdminData();
            closeMainMenu();
        }

        // تحميل بيانات الإدارة
        async function loadAdminData() {
            await loadAllUsers();
            loadRanks();
            loadAuditLog(); // تحميل سجل الرقابة
        }

        // تحميل جميع المستخدمين
        async function loadAllUsers() {
            try {
                const response = await fetch('/api/all-users', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                    }
                });
                if (response.ok) {
                    const users = await response.json();
                    displayAdminUsers(users);
                }
            } catch (error) {
                console.error('خطأ في تحميل المستخدمين:', error);
            }
        }

        // عرض المستخدمين في لوحة الإدارة
        function displayAdminUsers(users) {
            const container = document.getElementById('adminUsersList');
            container.innerHTML = '';
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'admin-user-item';
                const rank = RANKS[user.rank] || RANKS.visitor;
                const joinDate = new Date(user.created_at).toLocaleDateString('ar-SA');
                userDiv.innerHTML = `
                    <div class="admin-user-info">
                        <img class="admin-user-avatar" src="${user.profile_image1 || 'https://images.pexels.com/photos/771742/pexels-photo-771742.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop'}" alt="${user.display_name}">
                        <div class="admin-user-details">
                            <h4>${escapeHtml(user.display_name)}</h4>
                            <div class="admin-user-rank">${rank.emoji} ${rank.name} • انضم في ${joinDate}</div>
                        </div>
                    </div>
                    <div class="admin-user-actions">
                        <button class="admin-action-btn btn-info" onclick="openAssignRankModal(${user.id}, '${user.display_name}')">
                            <i class="fas fa-crown"></i> رتبة
                        </button>
                        <button class="admin-action-btn btn-warning" onclick="openBanUserModal(${user.id}, '${user.display_name}')">
                            <i class="fas fa-ban"></i> حظر
                        </button>
                        <button class="admin-action-btn btn-success" onclick="openGiveCoinsModal(${user.id}, '${user.display_name}')">
                            <i class="fas fa-coins"></i> نقاط
                        </button>
                    </div>
                `;
                container.appendChild(userDiv);
            });
        }

        // تحميل الرتب
        function loadRanks() {
            const container = document.getElementById('ranksList');
            container.innerHTML = '';
            Object.entries(RANKS).forEach(([key, rank]) => {
                const rankDiv = document.createElement('div');
                rankDiv.className = 'rank-item';
                rankDiv.innerHTML = `
                    <div class="rank-emoji">${rank.emoji}</div>
                    <div class="rank-name">${rank.name}</div>
                    <div class="rank-level">المستوى ${rank.level}</div>
                    <div class="rank-permissions">${rank.permissions.join(', ') || 'لا صلاحيات'}</div>
                `;
                container.appendChild(rankDiv);
            });
        }

        // فتح مودال تعيين الرتبة
        function openAssignRankModal(userId, userName) {
            document.getElementById('rankTargetUser').textContent = userName;
            document.getElementById('rankTargetUser').setAttribute('data-user-id', userId);
            // ملء قائمة الرتب
            const select = document.getElementById('newRankSelect');
            select.innerHTML = '';
            Object.entries(RANKS).forEach(([key, rank]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${rank.emoji} ${rank.name}`;
                select.appendChild(option);
            });
            openModal('assignRankModal');
        }

        // تأكيد تعيين الرتبة
        async function confirmAssignRank() {
            const userId = document.getElementById('rankTargetUser').getAttribute('data-user-id');
            const newRank = document.getElementById('newRankSelect').value;
            const reason = document.getElementById('rankChangeReason').value.trim();
            if (!newRank) {
                showError('يرجى اختيار رتبة');
                return;
            }
            try {
                showLoading(true);
                const response = await fetch('/api/assign-rank', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                    },
                    body: JSON.stringify({
                        userId: parseInt(userId),
                        newRank,
                        reason
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    // تسجيل الإجراء في سجل الرقابة
                    logAuditAction('assign_rank', userId, reason, newRank);
                    closeAssignRankModal();
                    loadAllUsers();
                    showNotification(data.message, 'success');
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('حدث خطأ في تعيين الرتبة');
            } finally {
                showLoading(false);
            }
        }

        // إغلاق مودال تعيين الرتبة
        function closeAssignRankModal() {
            closeModal('assignRankModal');
            document.getElementById('rankChangeReason').value = '';
        }

        // فتح مودال حظر المستخدم
        function openBanUserModal(userId, userName) {
            document.getElementById('banTargetUser').textContent = userName;
            document.getElementById('banTargetUser').setAttribute('data-user-id', userId);
            openModal('banUserModal');
        }

        // تأكيد حظر المستخدم
        async function confirmBanUser() {
            const userId = document.getElementById('banTargetUser').getAttribute('data-user-id');
            const reason = document.getElementById('banReason').value.trim();
            const duration = document.getElementById('banDuration').value;
            if (!reason) {
                showError('يرجى كتابة سبب الحظر');
                return;
            }
            try {
                showLoading(true);
                const response = await fetch('/api/ban', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                    },
                    body: JSON.stringify({
                        userId: parseInt(userId),
                        reason,
                        duration
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    // تسجيل الإجراء في سجل الرقابة
                    logAuditAction('ban', userId, reason, duration);
                    closeBanUserModal();
                    loadAllUsers();
                    showNotification(data.message, 'success');
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('حدث خطأ في حظر المستخدم');
            } finally {
                showLoading(false);
            }
        }

        // إغلاق مودال حظر المستخدم
        function closeBanUserModal() {
            closeModal('banUserModal');
            document.getElementById('banReason').value = '';
        }

        // فتح مودال كتم المستخدم
        function openMuteUserModal() {
            const userId = document.getElementById('actionUserAvatar').parentElement.querySelector('#actionUserName').getAttribute('data-user-id');
            const userName = document.getElementById('actionUserName').textContent;
            document.getElementById('muteTargetUser').textContent = userName;
            document.getElementById('muteTargetUser').setAttribute('data-user-id', userId);
            openModal('muteUserModal');
        }

        // كتم المستخدم
        async function muteUser() {
            const userId = document.getElementById('muteTargetUser').getAttribute('data-user-id');
            const reason = document.getElementById('muteReason').value.trim();
            const duration = document.getElementById('muteDuration').value;
            
            if (!reason) {
                showError('يرجى كتابة سبب الكتم');
                return;
            }
            
            try {
                showLoading(true);
                const response = await fetch('/api/mute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                    },
                    body: JSON.stringify({
                        userId: parseInt(userId),
                        reason,
                        duration
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    // تسجيل الإجراء في سجل الرقابة
                    logAuditAction('mute', userId, reason, duration);
                    closeModal('muteUserModal');
                    showNotification(`تم كتم المستخدم بسبب: ${reason}`, 'warning');
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('حدث خطأ في كتم المستخدم');
            } finally {
                showLoading(false);
            }
        }

        // فتح مودال إهداء النقاط
        function openGiveCoinsModal(userId, userName) {
            document.getElementById('coinsTargetUser').textContent = userName;
            document.getElementById('coinsTargetUser').setAttribute('data-user-id', userId);
            openModal('giveCoinsModal');
        }

        // إهداء النقاط
        async function giveCoins() {
            const userId = document.getElementById('coinsTargetUser').getAttribute('data-user-id');
            const amount = document.getElementById('coinsAmount').value;
            const reason = document.getElementById('coinsReason').value;
            if (!amount || amount < 1 || amount > 10000) {
                showError('يرجى إدخال عدد صحيح من النقاط (1-10000)');
                return;
            }
            try {
                showLoading(true);
                const response = await fetch('/api/give-coins', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                    },
                    body: JSON.stringify({
                        userId: parseInt(userId),
                        amount: parseInt(amount),
                        reason: reason
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    // تسجيل الإجراء في سجل الرقابة
                    logAuditAction('give_coins', userId, reason, amount);
                    closeGiveCoinsModal();
                    loadAllUsers();
                    showNotification(`تم إهداء ${amount} نقطة بنجاح`, 'success');
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('حدث خطأ في إهداء النقاط');
            } finally {
                showLoading(false);
            }
        }

        // إغلاق مودال إهداء النقاط
        function closeGiveCoinsModal() {
            closeModal('giveCoinsModal');
            document.getElementById('coinsAmount').value = '';
            document.getElementById('coinsReason').value = '';
        }

        // إغلاق لوحة الإدارة
        function closeAdminModal() {
            closeModal('adminModal');
        }

        // عرض تبويب الإدارة
        function showAdminTab(tabName) {
            // إخفاء جميع التبويبات
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // إزالة الفئة النشطة من جميع الأزرار
            document.querySelectorAll('.admin-tabs .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // عرض التبويب المحدد
            document.getElementById(`admin${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).classList.add('active');
            // تفعيل الزر المحدد
            event.target.classList.add('active');
        }

        // فتح الملف الشخصي
        function openProfileModal() {
            if (!currentUser) return;
            // ملء البيانات الحالية
            document.getElementById('displayNameInput').value = currentUser.display_name || '';
            document.getElementById('emailInput').value = currentUser.email || '';
            document.getElementById('ageInput').value = currentUser.age || '';
            document.getElementById('genderInput').value = currentUser.gender || '';
            document.getElementById('maritalStatusInput').value = currentUser.marital_status || '';
            document.getElementById('aboutMeInput').value = currentUser.about_me || '';
            // عرض الصور الحالية
            if (currentUser.profile_image1) {
                document.getElementById('profileImg1').src = currentUser.profile_image1;
            }
            if (currentUser.profile_image2) {
                document.getElementById('profileImg2').src = currentUser.profile_image2;
            }
            // عرض الإحصائيات
            document.getElementById('profileCoins').textContent = currentUser.coins || 2000;
            document.getElementById('profileRank').textContent = RANKS[currentUser.rank]?.name || 'زائر';
            // تشغيل موسيقى البروفايل إذا كانت موجودة
            if (currentUser.profile_music) {
                autoPlayProfileMusic(currentUser.profile_music);
            }
            openModal('profileModal');
        }

        // إغلاق الملف الشخصي
        function closeProfileModal() {
            closeModal('profileModal');
        }

        // عرض تبويب الملف الشخصي
        function showProfileTab(tabName) {
            // إخفاء جميع التبويبات
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // إزالة الفئة النشطة من جميع الأزرار
            document.querySelectorAll('.profile-tabs .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // عرض التبويب المحدد
            document.getElementById(`profile${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).classList.add('active');
            // تفعيل الزر المحدد
            event.target.classList.add('active');
        }

        // تحديث الملف الشخصي
        async function updateProfile() {
            const formData = new FormData();
            const displayName = document.getElementById('displayNameInput').value.trim();
            const email = document.getElementById('emailInput').value.trim();
            const newPassword = document.getElementById('newPasswordInput').value;
            const age = document.getElementById('ageInput').value;
            const gender = document.getElementById('genderInput').value;
            const maritalStatus = document.getElementById('maritalStatusInput').value;
            const aboutMe = document.getElementById('aboutMeInput').value.trim();
            if (displayName) formData.append('display_name', displayName);
            if (email) formData.append('email', email);
            if (newPassword) formData.append('password', newPassword);
            if (age) formData.append('age', age);
            if (gender) formData.append('gender', gender);
            if (maritalStatus) formData.append('marital_status', maritalStatus);
            if (aboutMe) formData.append('about_me', aboutMe);
            // إضافة الصور إذا تم اختيارها
            const profileFile1 = document.getElementById('profileFile1').files[0];
            const profileFile2 = document.getElementById('profileFile2').files[0];
            if (profileFile1) formData.append('profileImage1', profileFile1);
            if (profileFile2) formData.append('profileImage2', profileFile2);
            try {
                showLoading(true);
                const response = await fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                    },
                    body: formData
                });
                if (response.ok) {
                    const updatedUser = await response.json();
                    currentUser = { ...currentUser, ...updatedUser };
                    updateUserInterface();
                    showNotification('تم تحديث الملف الشخصي بنجاح', 'success');
                } else {
                    const data = await response.json();
                    showError(data.error || 'فشل في تحديث الملف الشخصي');
                }
            } catch (error) {
                showError('حدث خطأ في تحديث الملف الشخصي');
            } finally {
                showLoading(false);
            }
        }

        // فتح ملف شخصي لمستخدم آخر
        function openUserProfile(userId) {
            // هذه الوظيفة ستكون متاحة لاحقاً
            showNotification('عرض الملف الشخصي قيد التطوير', 'info');
        }

        // فتح الإشعارات
        function openNotifications() {
            openModal('notificationsModal');
            loadNotifications();
        }

        // تحميل الإشعارات
        function loadNotifications() {
            const container = document.getElementById('notificationsList');
            container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">لا توجد إشعارات جديدة</p>';
            // يمكنك تحميل الإشعارات الحقيقية من الخادم هنا
        }

        // إغلاق الإشعارات
        function closeNotificationsModal() {
            closeModal('notificationsModal');
        }

        // تحديث عدد الإشعارات
        function updateNotificationCount() {
            const badge = document.getElementById('notificationCount');
            let count = parseInt(badge.textContent) || 0;
            count++;
            badge.textContent = count;
            badge.style.display = count > 0 ? 'block' : 'none';
        }

        // فتح الإعدادات
        function openSettings() {
            openModal('settingsModal');
        }

        // إغلاق الإعدادات
        function closeSettingsModal() {
            closeModal('settingsModal');
        }

        // حفظ الإعدادات
        function saveSettings() {
            const soundNotifications = document.getElementById('soundNotifications').checked;
            const saveChatHistory = document.getElementById('saveChatHistory').checked;
            const filterBadWords = document.getElementById('filterBadWords').checked;
            localStorage.setItem('soundNotifications', soundNotifications);
            localStorage.setItem('saveChatHistory', saveChatHistory);
            localStorage.setItem('filterBadWords', filterBadWords);
            showNotification('تم حفظ الإعدادات', 'success');
            closeSettingsModal();
        }

        // الخروج من الدردشة
        function exitChat() {
            if (confirm('هل أنت متأكد من الخروج؟')) {
                logout();
            }
        }

        // الخروج من الغرفة
        function exitRoom() {
            currentRoom = 1;
            document.getElementById('roomSelect').value = 1;
            changeRoom();
            closeSettingsModal();
            showNotification('تم الخروج من الغرفة', 'info');
        }

        // فتح المساعدة
        function openHelpModal() {
            showNotification('المساعدة قيد التطوير', 'info');
        }

        // عرض الرتب
        function showRanks() {
            let ranksText = 'الرتب المتاحة:
';
            Object.values(RANKS).forEach(rank => {
                ranksText += `${rank.emoji} ${rank.name} (المستوى ${rank.level}) - الصلاحيات: ${rank.permissions.join(', ') || 'لا شيء'}
`;
            });
            alert(ranksText);
        }

        // تنظيف الغرف
        async function cleanRooms() {
            if (!hasPermission('delete_room') && currentUser?.role !== 'owner') {
                showError('غير مسموح - للإداريين فقط');
                return;
            }
            if (confirm('هل أنت متأكد من تنظيف جميع الرسائل؟')) {
                try {
                    const response = await fetch('/api/clean-rooms', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                        }
                    });
                    if (response.ok) {
                        document.getElementById('messagesContainer').innerHTML = '';
                        showNotification('تم تنظيف الغرفة بنجاح', 'success');
                    } else {
                        showError('فشل في تنظيف الغرفة');
                    }
                } catch (error) {
                    showError('حدث خطأ في تنظيف الغرفة');
                }
            }
        }

        // فتح مشغل الراديو
        function openRadioPlayer() {
            openModal('radioPlayerModal');
        }

        // إغلاق مشغل الراديو
        function closeRadioPlayer() {
            closeModal('radioPlayerModal');
        }

        // تشغيل محطة راديو
        function playRadioStation(station) {
            showNotification(`تم تشغيل محطة ${station}`, 'success');
            // هنا يمكن إضافة كود تشغيل الراديو الفعلي
        }

        // تبديل الراديو
        function toggleRadio() {
            const btn = document.getElementById('radioPlayBtn');
            const icon = btn.querySelector('i');
            if (icon.classList.contains('fa-play')) {
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
                showNotification('تم تشغيل الراديو', 'success');
            } else {
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-play');
                showNotification('تم إيقاف الراديو', 'info');
            }
        }

        // رفع موسيقى مخصصة
        function uploadCustomMusic() {
            const fileInput = document.getElementById('customMusicInput');
            if (fileInput.files.length === 0) {
                showError('يرجى اختيار ملفات صوتية');
                return;
            }
            if (!hasPermission('upload_music')) {
                showNotification('هذه الميزة متاحة للرتب العالية فقط', 'error');
                return;
            }
            showNotification('تم رفع الأغاني بنجاح', 'success');
            fileInput.value = '';
        }

        // تبديل مشغل الموسيقى
        function toggleMusicPlayer() {
            const btn = document.getElementById('musicToggle');
            const nowPlaying = document.getElementById('nowPlaying');
            if (nowPlaying.style.display === 'none') {
                nowPlaying.style.display = 'block';
                nowPlaying.querySelector('.song-title').textContent = 'تشغيل الموسيقى...';
                showNotification('تم تشغيل الموسيقى', 'success');
            } else {
                nowPlaying.style.display = 'none';
                showNotification('تم إيقاف الموسيقى', 'info');
            }
        }

        // البحث عن أغنية
        function searchMusic() {
            const query = document.getElementById('musicSearchInput').value.trim();
            if (!query) {
                showNotification('يرجى كتابة اسم الأغنية للبحث', 'warning');
                return;
            }
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<p style="text-align: center; padding: 10px;">جارٍ البحث...</p>';

            // محاكاة نتائج البحث
            setTimeout(() => {
                const mockResults = [
                    { title: 'أغنية جميلة', artist: 'فنان مشهور', cover: 'https://via.placeholder.com/50', url: '#song1' },
                    { title: 'أغنية رومانسية', artist: 'مطربة عربية', cover: 'https://via.placeholder.com/50', url: '#song2' },
                    { title: 'أغنية حماسية', artist: 'فرقة عالمية', cover: 'https://via.placeholder.com/50', url: '#song3' }
                ];

                resultsContainer.innerHTML = '';
                mockResults.forEach(song => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `
                        <img src="${song.cover}" class="result-cover">
                        <div class="result-info">
                            <div class="result-title">${escapeHtml(song.title)}</div>
                            <div class="result-artist">${escapeHtml(song.artist)}</div>
                        </div>
                    `;
                    item.onclick = () => playSearchedSong(song.url, song.title);
                    resultsContainer.appendChild(item);
                });
            }, 1000);
        }

        // تشغيل الأغنية التي تم البحث عنها
        function playSearchedSong(songUrl, songTitle) {
            // التحقق من الصلاحية
            if (!hasPermission('play_music')) {
                showNotification('هذه الميزة متاحة للرتب العالية فقط', 'error');
                return;
            }
            // محاكاة التشغيل
            const nowPlaying = document.getElementById('nowPlaying');
            nowPlaying.style.display = 'block';
            nowPlaying.classList.add('active');
            nowPlaying.querySelector('.song-title').textContent = `🎶 ${songTitle}`;
            showNotification(`تم تشغيل: ${songTitle}`, 'success');
            // تسجيل التشغيل في سجل الرقابة
            logAuditAction('play_music', currentUser?.id, 'تشغيل أغنية من البحث', songTitle);
        }

        // تسجيل الخروج
        function logout() {
            localStorage.removeItem('chatToken');
            currentUser = null;
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            showLoginScreen();
            showNotification('تم تسجيل الخروج', 'info');
        }

        // إعادة تحميل الصفحة
        function reloadPage() {
            location.reload();
        }

        // تحديث نقاط المستخدم
        function updateUserCoins(amount) {
            if (currentUser) {
                currentUser.coins = (currentUser.coins || 2000) + amount;
                document.getElementById('profileCoins').textContent = currentUser.coins;
            }
        }

        // فتح منتقي الرموز التعبيرية
        function openEmojiPicker() {
            const emojis = ['😀', '😂', '😍', '🥰', '😎', '🤔', '😢', '😡', '👍', '👎', '❤️', '🔥', '💯', '🎉', '🦂'];
            const input = document.getElementById('messageInput');
            let emojiHtml = '<div style="background: white; border: 1px solid #ccc; border-radius: 8px; padding: 10px; position: absolute; z-index: 1000; display: flex; flex-wrap: wrap; gap: 5px; max-width: 200px;">';
            emojis.forEach(emoji => {
                emojiHtml += `<span style="cursor: pointer; padding: 5px; border-radius: 4px; hover: background: #f0f0f0;" onclick="addEmoji('${emoji}')">${emoji}</span>`;
            });
            emojiHtml += '</div>';
            // إضافة منتقي الرموز بجانب حقل الإدخال
            const picker = document.createElement('div');
            picker.innerHTML = emojiHtml;
            picker.style.position = 'relative';
            input.parentNode.appendChild(picker);
            // إزالة المنتقي بعد 5 ثوان
            setTimeout(() => {
                picker.remove();
            }, 5000);
        }

        // إضافة رمز تعبيري
        function addEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
            // إزالة منتقي الرموز
            const picker = input.parentNode.querySelector('div');
            if (picker) picker.remove();
        }

        // فتح منتقي الصور المتحركة
        function openGifPicker() {
            showNotification('منتقي الصور المتحركة قيد التطوير', 'info');
        }

        // اقتباس رسالة
        function quoteMessage(messageId, author, content) {
            quotedMessage = { id: messageId, author, content };
            const quotedDiv = document.getElementById('quotedMessage');
            quotedDiv.style.display = 'flex';
            quotedDiv.querySelector('.quoted-author').textContent = author;
            quotedDiv.querySelector('.quoted-text').textContent = content.substring(0, 50) + (content.length > 50 ? '...' : '');
            document.getElementById('messageInput').focus();
        }

        // إلغاء الاقتباس
        function cancelQuote() {
            quotedMessage = null;
            document.getElementById('quotedMessage').style.display = 'none';
        }

        // فتح صورة في مودال
        function openImageModal(imageUrl) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90vw; max-height: 90vh; padding: 0; background: transparent; border: none; box-shadow: none;">
                    <img src="${imageUrl}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;" onclick="this.parentElement.parentElement.remove()">
                </div>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            document.body.appendChild(modal);
        }

        // مسح الدردشة
        async function clearChat() {
            if (!hasPermission('delete_message') && currentUser?.role !== 'owner') {
                showError('غير مسموح - للإداريين فقط');
                return;
            }
            if (confirm('هل أنت متأكد من مسح جميع الرسائل في هذه الغرفة؟')) {
                try {
                    const response = await fetch(`/api/rooms/${currentRoom}/clear`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                        }
                    });
                    if (response.ok) {
                        document.getElementById('messagesContainer').innerHTML = '';
                        showNotification('تم مسح الدردشة بنجاح', 'success');
                    } else {
                        showError('فشل في مسح الدردشة');
                    }
                } catch (error) {
                    showError('حدث خطأ في مسح الدردشة');
                }
            }
        }

        // إظهار تبويبات تسجيل الدخول
        function showLoginTab(tabName) {
            // إخفاء جميع النماذج
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active');
            });
            // إزالة الفئة النشطة من جميع الأزرار
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // عرض النموذج المحدد
            document.getElementById(`${tabName}Form`).classList.add('active');
            // تفعيل الزر المحدد
            event.target.classList.add('active');
        }

        // التمرير لأسفل
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        // إظهار رسالة خطأ
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.add('show');
                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 5000);
            } else {
                showNotification(message, 'error');
            }
        }

        // إظهار حالة التحميل
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) {
                spinner.style.display = show ? 'flex' : 'none';
            }
        }

        // إظهار إشعار
        function showNotification(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            // إزالة الإشعار بعد 5 ثوان
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // إشعار رسالة خاصة
        function showPrivateMessageNotification(message) {
            const notification = new Notification('رسالة خاصة جديدة', {
                body: `${message.display_name}: ${message.message.substring(0, 50)}...`,
                icon: 'https://images.pexels.com/photos/771742/pexels-photo-771742.jpeg?auto=compress&cs=tinysrgb&w=100&h=100&fit=crop'
            });
            notification.onclick = function() {
                window.focus();
                startPrivateChat(message.user_id, message.display_name);
                this.close();
            };
        }

        // فتح مودال
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }

        // إغلاق مودال
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        }

        // إغلاق جميع المودالات
        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('show');
            });
            document.body.style.overflow = 'auto';
        }

        // إغلاق إجراءات المستخدم
        function closeUserActionsModal() {
            closeModal('userActionsModal');
            selectedUserId = null;
        }

        // تهيئة الأصوات
        function initializeAudio() {
            // تحميل الأصوات المحفوظة
            const soundEnabled = localStorage.getItem('soundNotifications');
            if (soundEnabled !== null) {
                document.getElementById('soundNotifications').checked = soundEnabled === 'true';
            }
            
            // طلب إذن الإشعارات
            if (Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        // تشغيل صوت الإشعار
        function playNotificationSound() {
            const soundEnabled = document.getElementById('soundNotifications')?.checked;
            if (soundEnabled !== false) {
                const audio = document.getElementById('notificationSound');
                if (audio) {
                    audio.play().catch(() => {
                        // تجاهل الأخطاء إذا لم يتمكن من تشغيل الصوت
                    });
                }
            }
        }

        // تنظيف HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // معالج الأخطاء العامة
        window.addEventListener('error', function(e) {
            console.error('خطأ في التطبيق:', e.error);
            showNotification('حدث خطأ غير متوقع', 'error');
        });

        // معالج الأخطاء غير المعالجة
        window.addEventListener('unhandledrejection', function(e) {
            console.error('خطأ غير معالج:', e.reason);
            showNotification('حدث خطأ في الشبكة', 'error');
        });

        // ==================== الميزات الجديدة ====================
        // متغيرات الإشعارات والميزات الجديدة
        let onlineUsersList = [];
        let allUsersList = [];
        let notificationsList = [];
        let privateChatMinimized = false;
        let currentPrivateChatUser = null;
        // متغيرات للميزات الجديدة
        var currentMusicPlayer = null;
        var isContestActive = false;
        var contestTimer = null;

        // وظائف إرسال الصور
        function openImagePicker() {
            const imageInput = document.createElement('input');
            imageInput.type = 'file';
            imageInput.accept = 'image/*';
            imageInput.multiple = true;
            imageInput.onchange = function(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    for (let i = 0; i < files.length; i++) {
                        uploadImage(files[i]);
                    }
                }
            };
            imageInput.click();
        }

        function uploadImage(file) {
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert('حجم الصورة كبير جداً! الحد الأقصى 10 ميجابايت');
                return;
            }
            const formData = new FormData();
            formData.append('image', file);
            formData.append('roomId', currentRoom);
            // عرض مؤشر التحميل
            showUploadProgress('جاري رفع الصورة...');
            fetch('/upload-image', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('chatToken')
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideUploadProgress();
                if (data.success) {
                    // إرسال رسالة مع رابط الصورة
                    socket.emit('sendMessage', {
                        message: '',
                        imageUrl: data.imageUrl,
                        roomId: currentRoom,
                        type: 'image'
                    });
                } else {
                    alert('فشل في رفع الصورة: ' + data.message);
                }
            })
            .catch(error => {
                hideUploadProgress();
                console.error('خطأ في رفع الصورة:', error);
                alert('حدث خطأ أثناء رفع الصورة');
            });
        }

        function openPrivateImagePicker(receiverId) {
            const imageInput = document.createElement('input');
            imageInput.type = 'file';
            imageInput.accept = 'image/*';
            imageInput.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    uploadPrivateImage(file, receiverId);
                }
            };
            imageInput.click();
        }

        function uploadPrivateImage(file, receiverId) {
            if (file.size > 10 * 1024 * 1024) { 
                alert('حجم الصورة كبير جداً! الحد الأقصى 10 ميجابايت');
                return;
            }
            const formData = new FormData();
            formData.append('image', file);
            formData.append('receiverId', receiverId);
            showUploadProgress('جاري رفع الصورة الخاصة...');
            fetch('/upload-private-image', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('chatToken')
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideUploadProgress();
                if (data.success) {
                    socket.emit('sendPrivateMessage', {
                        message: '',
                        imageUrl: data.imageUrl,
                        receiverId: receiverId,
                        type: 'image'
                    });
                } else {
                    alert('فشل في رفع الصورة: ' + data.message);
                }
            })
            .catch(error => {
                hideUploadProgress();
                console.error('خطأ في رفع الصورة الخاصة:', error);
                alert('حدث خطأ أثناء رفع الصورة');
            });
        }

        function showUploadProgress(message) {
            const progressDiv = document.createElement('div');
            progressDiv.id = 'uploadProgress';
            progressDiv.className = 'upload-progress';
            progressDiv.innerHTML = `
                <div class="upload-progress-content">
                    <div class="upload-spinner"></div>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(progressDiv);
        }

        function hideUploadProgress() {
            const progressDiv = document.getElementById('uploadProgress');
            if (progressDiv) {
                progressDiv.remove();
            }
        }

        // وظائف معاينة فيديو يوتيوب
        function detectAndProcessYouTubeLinks(message) {
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/g;
            const matches = message.match(youtubeRegex);
            if (matches) {
                matches.forEach(match => {
                    const videoId = extractYouTubeVideoId(match);
                    if (videoId) {
                        message = message.replace(match, createYouTubeEmbed(videoId));
                    }
                });
            }
            return message;
        }

        function extractYouTubeVideoId(url) {
            const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        function createYouTubeEmbed(videoId) {
            return `
                <div class="youtube-embed">
                    <iframe 
                        width="300" 
                        height="200" 
                        src="https://www.youtube.com/embed/${videoId}" 
                        frameborder="0" 
                        allowfullscreen>
                    </iframe>
                    <div class="youtube-info">
                        <span>🎥 فيديو يوتيوب</span>
                    </div>
                </div>
            `;
        }

        // وظائف حذف الرسائل
        function deleteMessage(messageId, messageElement) {
            if (confirm('هل أنت متأكد من حذف هذه الرسالة؟')) {
                fetch('/api/delete-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                    },
                    body: JSON.stringify({ messageId: messageId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        messageElement.innerHTML = '<em>تم حذف هذه الرسالة</em>';
                        messageElement.classList.add('deleted-message');
                        // تسجيل الإجراء في سجل الرقابة
                        logAuditAction('delete_message', currentUser?.id, 'حذف رسالة', messageId);
                    } else {
                        alert('فشل في حذف الرسالة: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('خطأ في حذف الرسالة:', error);
                });
            }
        }

        // وظائف الطرد والكتم
        function kickUser(userId, userName) {
            if (!hasPermission('ban_user')) {
                showError('غير مسموح لك بتنفيذ هذا الإجراء');
                return;
            }
            if (confirm(`هل تريد طرد ${userName} من الغرفة؟`)) {
                socket.emit('kickUser', {
                    userId: userId,
                    roomId: currentRoom
                });
                // تسجيل الإجراء في سجل الرقابة
                logAuditAction('kick', userId, 'طرد من الغرفة', currentRoom);
            }
        }

        function muteUser(userId, userName) {
            if (!hasPermission('mute_user')) {
                showError('غير مسموح لك بتنفيذ هذا الإجراء');
                return;
            }
            const duration = prompt(`كم دقيقة تريد كتم ${userName}؟ (اترك فارغاً للكتم الدائم)`, '10');
            if (duration !== null) {
                const muteMinutes = duration === '' ? null : parseInt(duration);
                socket.emit('muteUser', {
                    userId: userId,
                    roomId: currentRoom,
                    duration: muteMinutes
                });
                // تسجيل الإجراء في سجل الرقابة
                logAuditAction('mute', userId, 'كتم في الغرفة', `${duration} دقائق`);
            }
        }

        function unmuteUser(userId, userName) {
            if (!hasPermission('mute_user')) {
                showError('غير مسموح لك بتنفيذ هذا الإجراء');
                return;
            }
            if (confirm(`هل تريد إلغاء كتم ${userName}؟`)) {
                socket.emit('unmuteUser', {
                    userId: userId,
                    roomId: currentRoom
                });
                // تسجيل الإجراء في سجل الرقابة
                logAuditAction('unmute', userId, 'إلغاء كتم', currentRoom);
            }
        }

        // وظائف إنشاء الغرف
        function openCreateRoomModal() {
            if (!hasPermission('create_room') && currentUser?.role !== 'owner') {
                showError('غير مسموح - للإداريين فقط');
                return;
            }
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'createRoomModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="closeCreateRoomModal()">&times;</span>
                    <h2>🏠 إنشاء غرفة جديدة</h2>
                    <div class="room-form">
                        <div class="form-group">
                            <label>اسم الغرفة:</label>
                            <input type="text" id="roomName" placeholder="ادخل اسم الغرفة" required>
                        </div>
                        <div class="form-group">
                            <label>وصف الغرفة:</label>
                            <textarea id="roomDescription" placeholder="ادخل وصف للغرفة"></textarea>
                        </div>
                        <div class="form-group">
                            <label>نوع الغرفة:</label>
                            <select id="roomType">
                                <option value="public">عامة</option>
                                <option value="private">خاصة</option>
                                <option value="quiz">مسابقات</option>
                                <option value="music">موسيقى</option>
                                <option value="game">ألعاب</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>الحد الأقصى للمستخدمين:</label>
                            <input type="number" id="maxUsers" value="50" min="2" max="200">
                        </div>
                        <div class="form-group">
                            <label>صلاحيات الدخول:</label>
                            <select id="roomAccessRank">
                                <option value="visitor">الجميع</option>
                                <option value="bronze">برونزي فما فوق</option>
                                <option value="silver">فضي فما فوق</option>
                                <option value="gold">ذهبي فما فوق</option>
                                <option value="diamond">الماس فما فوق</option>
                                <option value="moderator">المشرفون فما فوق</option>
                            </select>
                        </div>
                        <div class="room-actions">
                            <button onclick="createRoom()" class="btn save-btn">إنشاء الغرفة</button>
                            <button onclick="closeCreateRoomModal()" class="btn cancel-btn">إلغاء</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeCreateRoomModal() {
            const modal = document.getElementById('createRoomModal');
            if (modal) {
                modal.remove();
            }
        }

        function createRoom() {
            const roomName = document.getElementById('roomName').value.trim();
            const roomDescription = document.getElementById('roomDescription').value.trim();
            const roomType = document.getElementById('roomType').value;
            const maxUsers = parseInt(document.getElementById('maxUsers').value);
            const accessRank = document.getElementById('roomAccessRank').value;
            if (!roomName) {
                alert('يرجى إدخال اسم الغرفة');
                return;
            }
            socket.emit('createRoom', {
                name: roomName,
                description: roomDescription,
                type: roomType,
                maxUsers: maxUsers,
                accessRank: accessRank
            });
            // تسجيل الإجراء في سجل الرقابة
            logAuditAction('create_room', currentUser?.id, 'إنشاء غرفة جديدة', roomName);
            closeCreateRoomModal();
        }

        // ==================== وظائف الإشعارات ====================
        // فتح مودال إرسال إشعار
        function openSendNotificationModal() {
            if (!hasPermission('send_global_notification') && currentUser?.role !== 'owner') {
                showNotification('غير مسموح - للإداريين فقط', 'error');
                return;
            }
            openModal('sendNotificationModal');
            loadUsersForNotification();
            closeMainMenu();
        }

        // إغلاق مودال إرسال إشعار
        function closeSendNotificationModal() {
            closeModal('sendNotificationModal');
            document.getElementById('notificationMessage').value = '';
            document.getElementById('notificationRecipient').value = '';
        }

        // تحميل المستخدمين لقائمة الإشعارات
        async function loadUsersForNotification() {
            try {
                const response = await fetch('/api/all-users-list', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                    }
                });
                if (response.ok) {
                    const users = await response.json();
                    const select = document.getElementById('notificationRecipient');
                    select.innerHTML = '<option value="">اختر مستخدم...</option>';
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.display_name} (${RANKS[user.rank]?.name || 'زائر'})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('خطأ في تحميل المستخدمين:', error);
            }
        }

        // إرسال إشعار للمستخدم
        async function sendNotificationToUser() {
            const recipientId = document.getElementById('notificationRecipient').value;
            const message = document.getElementById('notificationMessage').value.trim();
            const type = document.getElementById('notificationType').value;
            if (!recipientId) {
                showNotification('يرجى اختيار مستخدم', 'warning');
                return;
            }
            if (!message) {
                showNotification('يرجى كتابة رسالة الإشعار', 'warning');
                return;
            }
            try {
                showLoading(true);
                const response = await fetch('/api/send-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                    },
                    body: JSON.stringify({
                        recipientId: parseInt(recipientId),
                        message,
                        type
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    // تسجيل الإجراء في سجل الرقابة
                    logAuditAction('send_notification', currentUser?.id, 'إرسال إشعار', `إلى ${recipientId}: ${message}`);
                    showNotification('تم إرسال الإشعار بنجاح', 'success');
                    closeSendNotificationModal();
                } else {
                    showNotification(data.error || 'فشل في إرسال الإشعار', 'error');
                }
            } catch (error) {
                showNotification('حدث خطأ في إرسال الإشعار', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ==================== قائمة المتصلين حالياً ====================
        // فتح مودال المتصلين حالياً
        function openOnlineUsersModal() {
            openModal('onlineUsersModal');
            displayOnlineUsers();
            closeMainMenu();
        }

        // إغلاق مودال المتصلين حالياً
        function closeOnlineUsersModal() {
            closeModal('onlineUsersModal');
        }

        // عرض المتصلين حالياً
        function displayOnlineUsers() {
            const container = document.getElementById('onlineUsersList');
            if (onlineUsersList.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">لا يوجد مستخدمين متصلين حالياً</p>';
                return;
            }
            container.innerHTML = '';
            onlineUsersList.forEach(user => {
                if (user.userId === currentUser?.id) return; // لا نعرض المستخدم الحالي
                const userDiv = document.createElement('div');
                userDiv.className = 'online-user-item';
                const rank = RANKS[user.rank] || RANKS.visitor;
                userDiv.innerHTML = `
                    <div class="online-user-info">
                        <div class="online-status-indicator"></div>
                        <div class="user-details">
                            <span class="user-name">${escapeHtml(user.displayName)}</span>
                            <span class="user-rank">${rank.emoji} ${rank.name}</span>
                        </div>
                    </div>
                    <div class="online-user-actions">
                        <button onclick="startPrivateChat(${user.userId}, '${escapeHtml(user.displayName)}')" class="btn btn-sm btn-primary" title="دردشة خاصة">
                            <i class="fas fa-comment"></i>
                        </button>
                        ${hasPermission('send_global_notification') ? `
                            <button onclick="openNotificationModalForUser(${user.userId}, '${escapeHtml(user.displayName)}')" class="btn btn-sm btn-info" title="إرسال إشعار">
                                <i class="fas fa-bell"></i>
                            </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(userDiv);
            });
        }

        // بدء دردشة خاصة
        function startPrivateChat(userId, userName) {
            currentPrivateChatUser = { id: userId, name: userName };
            openPrivateChatBox();
            closeOnlineUsersModal();
            // تحديث قائمة المستخدمين في صندوق الدردشة الخاصة
            const select = document.getElementById('privateChatUserSelect');
            select.value = userId;
            // تحديث عنوان صندوق الدردشة
            const titleSpan = document.querySelector('.chat-box-title span');
            titleSpan.textContent = `دردشة خاصة مع ${userName}`;
            // تحميل الرسائل الخاصة
            loadPrivateMessages(userId);
        }

        // ==================== صندوق الدردشة الخاصة ====================
        // فتح صندوق الدردشة الخاصة
        function openPrivateChatBox() {
            const chatBox = document.getElementById('privateChatBox');
            chatBox.style.display = 'block';
            privateChatMinimized = false;
            // تحميل المستخدمين في القائمة
            loadUsersForPrivateChat();
            closeMainMenu();
        }

        // إغلاق صندوق الدردشة الخاصة
        function closePrivateChatBox() {
            const chatBox = document.getElementById('privateChatBox');
            chatBox.style.display = 'none';
            currentPrivateChatUser = null;
        }

        // تصغير صندوق الدردشة الخاصة
        function minimizePrivateChatBox() {
            const chatBox = document.getElementById('privateChatBox');
            const body = chatBox.querySelector('.chat-box-body');
            if (privateChatMinimized) {
                body.style.display = 'block';
                privateChatMinimized = false;
            } else {
                body.style.display = 'none';
                privateChatMinimized = true;
            }
        }

        // تحميل المستخدمين للدردشة الخاصة
        async function loadUsersForPrivateChat() {
            try {
                const response = await fetch('/api/all-users-list', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                    }
                });
                if (response.ok) {
                    const users = await response.json();
                    const select = document.getElementById('privateChatUserSelect');
                    select.innerHTML = '<option value="">اختر مستخدم...</option>';
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.display_name} ${user.is_online ? '🟢' : '🔴'}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('خطأ في تحميل المستخدمين:', error);
            }
        }

        // إرسال رسالة خاصة
        function sendPrivateChatMessage() {
            const input = document.getElementById('privateChatInput');
            const userSelect = document.getElementById('privateChatUserSelect');
            const message = input.value.trim();
            const receiverId = userSelect.value;
            if (!message) {
                showNotification('يرجى كتابة رسالة', 'warning');
                return;
            }
            if (!receiverId) {
                showNotification('يرجى اختيار مستخدم', 'warning');
                return;
            }
            if (socket) {
                socket.emit('sendPrivateMessage', {
                    message: message,
                    receiverId: parseInt(receiverId)
                });
                input.value = '';
            }
        }

        // عرض رسالة خاصة في صندوق الدردشة
        function displayPrivateMessage(message) {
            const container = document.getElementById('privateChatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `private-message ${message.user_id === currentUser?.id ? 'own' : ''}`;
            const time = new Date(message.timestamp).toLocaleTimeString('ar-SA', {
                hour: '2-digit',
                minute: '2-digit'
            });
            messageDiv.innerHTML = `
                <div class="private-message-content">
                    <div class="private-message-header">
                        <span class="private-message-author">${escapeHtml(message.display_name)}</span>
                        <span class="private-message-time">${time}</span>
                    </div>
                    <div class="private-message-text">${escapeHtml(message.message)}</div>
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // تحميل الرسائل الخاصة
        async function loadPrivateMessages(userId) {
            try {
                const response = await fetch(`/api/private-messages/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('chatToken')}`
                    }
                });
                if (response.ok) {
                    const messages = await response.json();
                    const container = document.getElementById('privateChatMessages');
                    container.innerHTML = '';
                    if (messages.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">لا توجد رسائل بعد، ابدأ المحادثة!</p>';
                    } else {
                        messages.forEach(message => {
                            displayPrivateMessage(message);
                        });
                    }
                }
            } catch (error) {
                console.error('خطأ في تحميل الرسائل الخاصة:', error);
            }
        }

        // تشغيل الأغنية تلقائياً في البروفايل
        function autoPlayProfileMusic(musicUrl) {
            if (musicUrl) {
                const audio = new Audio(musicUrl);
                audio.volume = 0.3;
                audio.loop = false;
                // محاولة تشغيل الأغنية
                audio.play().catch(error => {
                    console.log('لا يمكن تشغيل الأغنية تلقائياً:', error);
                    // إضافة زر تشغيل إذا فشل التشغيل التلقائي
                    addManualPlayButton(audio);
                });
                return audio;
            }
        }

        function addManualPlayButton(audio) {
            const playButton = document.createElement('button');
            playButton.innerHTML = '🎵 تشغيل الأغنية';
            playButton.className = 'play-music-btn';
            playButton.onclick = () => {
                audio.play();
                playButton.style.display = 'none';
            };
            const profileModal = document.querySelector('.modal.active .modal-content');
            if (profileModal) {
                profileModal.appendChild(playButton);
            }
        }

        // بلاغ عن رسالة
        function reportMessage(messageId) {
            const reason = prompt('يرجى كتابة سبب البلاغ:');
            if (reason) {
                // إرسال البلاغ للإدارة
                socket.emit('reportMessage', {
                    messageId: messageId,
                    reporterId: currentUser?.id,
                    reason: reason
                });
                showNotification('تم إرسال البلاغ للإدارة', 'success');
                // تسجيل الإجراء في سجل الرقابة
                logAuditAction('report_message', currentUser?.id, reason, messageId);
            }
        }

        // إشعار حول رسالة
        function notifyAboutMessage(messageId, author) {
            const message = prompt('اكتب رسالة الإشعار:');
            if (message) {
                socket.emit('notifyAboutMessage', {
                    messageId: messageId,
                    senderId: currentUser?.id,
                    message: message,
                    author: author
                });
                showNotification('تم إرسال الإشعار', 'success');
            }
        }

        // فتح مودال إرسال إشعار لمستخدم محدد من قائمة المتصلين
        function openNotificationModalForUser(userId, userName) {
            if (!hasPermission('send_global_notification')) {
                showError('غير مسموح لك بتنفيذ هذا الإجراء');
                return;
            }
            document.getElementById('notificationRecipient').value = userId;
            openSendNotificationModal();
        }

        // تسجيل الإجراء في سجل الرقابة
        function logAuditAction(action, targetUserId, reason, details = null) {
            const auditLog = {
                timestamp: new Date().toISOString(),
                adminId: currentUser?.id,
                adminName: currentUser?.display_name,
                action: action,
                targetUserId: targetUserId,
                reason: reason,
                details: details
            };

            // إضافة إلى قائمة سجل الرقابة في الذاكرة
            let auditLogs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
            auditLogs.push(auditLog);
            localStorage.setItem('auditLogs', JSON.stringify(auditLogs));

            // تحديث واجهة سجل الرقابة إذا كانت مفتوحة
            updateAuditLogDisplay();
        }

        // تحديث عرض سجل الرقابة
        function updateAuditLogDisplay() {
            const auditLogList = document.getElementById('auditLogList');
            if (!auditLogList) return;

            const logs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
            auditLogList.innerHTML = '';

            logs.reverse().forEach(log => {
                const item = document.createElement('div');
                item.className = 'audit-item';
                item.innerHTML = `
                    <span class="timestamp">[${new Date(log.timestamp).toLocaleString('ar-SA')}]</span>
                    <span class="admin">[المشرف: ${log.adminName}]</span>
                    <span class="action">${getActionText(log.action)} المستخدم [${log.targetUserId}] بسبب [${log.reason}] ${log.details ? `(${log.details})` : ''}</span>
                `;
                auditLogList.appendChild(item);
            });
        }

        // الحصول على نص الإجراء
        function getActionText(action) {
            const actions = {
                'ban': 'حظر',
                'mute': 'كتم',
                'kick': 'طرد',
                'assign_rank': 'تعيين رتبة',
                'give_coins': 'إعطاء نقاط',
                'create_room': 'إنشاء غرفة',
                'delete_message': 'حذف رسالة',
                'send_notification': 'إرسال إشعار',
                'play_music': 'تشغيل موسيقى',
                'report_message': 'بلاغ عن رسالة'
            };
            return actions[action] || action;
        }

        // تحميل سجل الرقابة
        function loadAuditLog() {
            updateAuditLogDisplay();
        }
    </script>
</body>
</html>
